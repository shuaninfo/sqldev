(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-14831067"],{"0b76":function(e,t,s){},"30ae":function(e,t,s){"use strict";var a=s("ca3a"),i=s.n(a);i.a},"30e7":function(e,t,s){},3371:function(e,t,s){"use strict";var a=s("4d13"),i=s.n(a);i.a},"4d13":function(e,t,s){},5386:function(e,t,s){},5716:function(e,t,s){},"71a7":function(e,t,s){"use strict";var a=s("30e7"),i=s.n(a);i.a},"77ca":function(e,t,s){"use strict";var a=s("0b76"),i=s.n(a);i.a},a9ab:function(e,t,s){},b9c7b:function(e,t,s){"use strict";var a=s("a9ab"),i=s.n(a);i.a},bff1:function(e,t,s){},ca3a:function(e,t,s){},dc82:function(e,t,s){"use strict";var a=s("5386"),i=s.n(a);i.a},e11e:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return e.isShow?s("el-dialog",{attrs:{title:e.title,visible:e.isShow,fullscreen:"",width:"100%","before-close":e.hide,center:""},on:{"update:visible":function(t){e.isShow=t},open:e.showHandle}},[s("div",{staticClass:"role"},[s("el-row",{staticClass:"el-row",attrs:{gutter:12}},[s("el-col",{attrs:{span:5}},[s("role-list",{ref:"roleList",attrs:{project_id:e.projectId,project:e.selectProject},on:{role:e.onRole,"on-project":e.onProject}})],1),s("el-col",{attrs:{span:7}},[s("instance-list",{ref:"dbList",attrs:{project_id:e.projectId,project:e.selectProject},on:{owner:e.onOwner,"refresh-next":e.onRefreshNext}})],1),s("el-col",{staticClass:"col-table-list",attrs:{span:7}},[s("table-list",{ref:"tabList",attrs:{role:e.selectRole,project_id:e.projectId,project:e.selectProject,owner:e.selectOwner},on:{"refresh-next":e.onRefreshNext,table:e.onTable}})],1),s("el-col",{attrs:{span:5}},[s("column-list",{ref:"colList",attrs:{role:e.selectRole,project_id:e.projectId,owner:e.selectOwner,table:e.selectTable,type:e.selectType}})],1)],1)],1)]):e._e()},i=[],o=(s("b0c0"),s("b64b"),function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("k-card",{attrs:{head:"角色列表",id:e.project_id,list:e.projectList},on:{sel:e.selItem}},[s("span",[s("el-input",{staticClass:"input-with-select",attrs:{placeholder:"输入关键字进行过滤",size:"small",clearable:""},model:{value:e.filterText,callback:function(t){e.filterText=t},expression:"filterText"}})],1),s("template",{slot:"tools"},[s("el-tooltip",{attrs:{content:"新建项目角色,新建后双击角色名可进行修改或删除"}},[s("el-button",{attrs:{type:"primary",size:"mini"},on:{click:e.showAddRole}},[e._v("新建角色")])],1)],1),s("div",{staticClass:"role-role-list"},[s("el-tree",{ref:"roleList",attrs:{data:e.dataList,props:e.treeProps,"node-key":"id","highlight-current":"","filter-node-method":e.filterNode},scopedSlots:e._u([{key:"default",fn:function(t){var a=t.data;return s("div",{staticClass:"role-row pointer-default item hbox-between hbox-center",on:{click:function(t){return e.onClick(a)}}},[s("div",{staticClass:"left margin-right-12"},[s("span",{on:{dblclick:function(t){return e.onEdit(a)}}},[e._v(e._s(a.name))])]),s("div",{staticClass:"right"},[s("span",{staticClass:"pointer-active",attrs:{title:"关联/移除用户"},on:{click:function(t){return t.stopPropagation(),e.$refs.userDialog.show(a,e.project)}}},[s("i",{staticClass:"sn-font"},[e._v("")]),e._v(" ("+e._s(a.userCount)+") ")]),s("span",{staticClass:"pointer-active",attrs:{title:"关联/移除数据源"},on:{click:function(t){return t.stopPropagation(),e.$refs.dbDialog.show(a)}}},[s("i",{staticClass:"sn-font"},[e._v("")]),e._v(" ("+e._s(a.dbCount)+") ")]),s("span",{staticClass:"pointer-active",attrs:{title:"关联/移除策略"},on:{click:function(t){return t.stopPropagation(),e.$refs.strategyDialog.show(a)}}},[s("i",{staticClass:"sn-font"},[e._v("")]),e._v(" ("+e._s(a.strategyCount)+") ")])])])}}])})],1),s("dialog-user",{ref:"userDialog",on:{refresh:e.refresh}}),s("dialog-db",{ref:"dbDialog",on:{refresh:e.refresh}}),s("dialog-role",{ref:"roleDialog",on:{refresh:e.refresh}}),s("dialog-strategy",{ref:"strategyDialog",on:{refresh:e.refresh}})],2)}),n=[],l=(s("4de4"),s("c975"),s("ac1f"),s("1276"),function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-dialog",{attrs:{"append-to-body":"",title:e.project.name+"-"+e.role.name+"-【用户设置】",visible:e.isShow,width:"950px"},on:{"update:visible":function(t){e.isShow=t}}},[s("el-alert",{attrs:{title:"提示:",description:"同一用户在同个项目中只能设置一个角色,加入当前角色后自动退出其他角色。",type:"info",closable:!1,"show-icon":""}}),s("k-search-table",{ref:"st",attrs:{select:"onSelect",url:"/api/role/user/page","search-data":e.search,manual:!0},on:{select:e.onSelect,reset:e.resetSearch}},[s("template",{slot:"searchs"},[s("el-form-item",{attrs:{label:"用户名",prop:"name",size:"mini"}},[s("el-input",{staticStyle:{width:"120px"},attrs:{size:"mini"},model:{value:e.search.name,callback:function(t){e.$set(e.search,"name",t)},expression:"search.name"}})],1),s("el-form-item",{attrs:{label:"姓名",prop:"user_name"}},[s("el-input",{staticStyle:{width:"120px"},attrs:{size:"mini"},model:{value:e.search.user_name,callback:function(t){e.$set(e.search,"user_name",t)},expression:"search.user_name"}})],1),s("el-form-item",{attrs:{label:"关联状态"}},[s("el-select",{staticStyle:{width:"120px"},attrs:{clearable:!0,size:"mini"},model:{value:e.search.rel_type,callback:function(t){e.$set(e.search,"rel_type",t)},expression:"search.rel_type"}},e._l(e.rel_types,(function(e){return s("el-option",{key:e.k,attrs:{label:e.v,value:e.k}})})),1)],1)],1),s("template",{slot:"buttons"},[s("el-button",{attrs:{type:"primary",size:"mini",disabled:""==e.ids},on:{click:e.onBatchAdd}},[e._v("批量添加")]),s("el-button",{attrs:{type:"danger",size:"mini",disabled:""==e.ids},on:{click:e.onBatchRemove}},[e._v("批量移除")])],1),s("template",{slot:"columns"},[s("el-table-column",{attrs:{label:"id",prop:"id",width:"80"}}),s("el-table-column",{attrs:{label:"用户名",prop:"name"}}),s("el-table-column",{attrs:{label:"姓名",prop:"user_name"}}),s("el-table-column",{attrs:{label:"角色",prop:"role_name"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.role_name)+" ")]}}])}),s("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[0==t.row.role_id?s("el-button",{attrs:{type:"warning",size:"mini",plain:"",disabled:2==e.user.role&&e.user.role>=t.row.role&&e.user.id!=t.row.id},on:{click:function(s){return e.onAdd(t.row.id)}}},[e._v("添加 ")]):e._e(),0!=t.row.role_id?s("el-button",{attrs:{type:"danger",size:"mini",plain:"",disabled:2==e.user.role&&e.user.role>=t.row.role&&e.user.id!=t.row.id},on:{click:function(s){return e.onRemove(t.row.id)}}},[e._v("移除 ")]):e._e()]}}])})],1)],2),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{on:{click:e.hide}},[e._v("关闭")])],1)],1)}),r=[],c=(s("a15b"),s("841c"),s("5530")),h=(s("365c"),s("2ef0")),d=s("2f62"),u={data:function(){return{ids:"",role:{},project:{},isShow:!1,search:{},rel_types:[{k:"",v:"全部"},{k:"1",v:"已关联当前角色"},{k:"2",v:"未关联当前角色"},{k:"4",v:"未关联任何角色"},{k:"3",v:"已关联其他角色"}]}},props:{},watch:{},computed:Object(c["a"])({},Object(d["c"])(["user"])),methods:{onSelect:function(e){console.log("onSelect val:",e);for(var t=[],s=0;s<e.length;s++)t.push(e[s].id);console.log("ids:",t.join(",")),this.ids=t.join(",")},resetSearch:function(){console.log("========resetSearch========="),this.search={},this.search.role_id=this.role.id},refresh:function(){this.$refs.st.search(),this.$emit("refresh")},show:function(e,t){var s=this;this.project=t,this.role=e,this.search.role_id=e.id,this.search.project=e.project,this.isShow=!0,this.$nextTick((function(){s.refresh()}))},hide:function(e){this.isShow=!1},onBatchAdd:function(){""!=this.ids&&this.onAdd(this.ids)},onBatchRemove:function(){""!=this.ids&&this.onRemove(this.ids)},onAdd:function(e){var t=this;this.$api.role.relation(this.role,e).then((function(){t.onSuccess("添加成功"),t.refresh()}))},onRemove:function(e){var t=this;this.$api.role.kick(this.role,e).then((function(){t.onSuccess("移除成功"),t.refresh()}))},onSubmit:function(){}},mounted:function(){},components:{}},f=u,p=s("2877"),m=Object(p["a"])(f,l,r,!1,null,null,null),b=m.exports,v=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-dialog",{attrs:{title:"【"+e.role.name+"】-- 数据源",visible:e.isShow,width:"950px","append-to-body":""},on:{"update:visible":function(t){e.isShow=t}}},[s("k-search-table",{ref:"st",attrs:{select:"onSelect",url:"/api/role/db/page","search-data":e.search,manual:!0},on:{select:e.onSelect,reset:e.resetSearch}},[s("template",{slot:"searchs"},[s("el-form-item",{attrs:{label:"名称",prop:"name"}},[s("el-input",{model:{value:e.search.name,callback:function(t){e.$set(e.search,"name",t)},expression:"search.name"}})],1),s("el-form-item",{attrs:{label:"数据源类型:"}},[s("el-select",{attrs:{clearable:!0},model:{value:e.search.db_type,callback:function(t){e.$set(e.search,"db_type",t)},expression:"search.db_type"}},e._l(e.db_types,(function(e){return s("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)],1),s("el-form-item",{attrs:{label:"关联状态"}},[s("el-select",{staticStyle:{width:"120px"},attrs:{clearable:!0,size:"mini"},model:{value:e.search.rel_type,callback:function(t){e.$set(e.search,"rel_type",t)},expression:"search.rel_type"}},e._l(e.rel_types,(function(e){return s("el-option",{key:e.k,attrs:{label:e.v,value:e.k}})})),1)],1)],1),s("template",{slot:"buttons"},[s("el-button",{attrs:{type:"primary",size:"mini",disabled:""==e.ids},on:{click:e.onBatchAdd}},[e._v("批量添加")]),s("el-button",{attrs:{type:"danger",size:"mini",disabled:""==e.ids},on:{click:e.onBatchRemove}},[e._v("批量移除")])],1),s("template",{slot:"columns"},[s("el-table-column",{attrs:{label:"数据源",prop:"name",width:"280"}}),s("el-table-column",{attrs:{label:"类型",prop:"db_type"}}),s("el-table-column",{attrs:{label:"启用",width:"50px"},scopedSlots:e._u([{key:"default",fn:function(t){return[1==t.row.state?s("span",{staticClass:"text-info"},[e._v(" 是 ")]):s("span",{staticClass:"text-warn"},[e._v(" 否 ")])]}}])}),s("el-table-column",{attrs:{label:"连接状态",width:"90px"},scopedSlots:e._u([{key:"default",fn:function(t){return[1==t.row.state?s("div",[3==t.row.con_state?s("el-tooltip",{attrs:{content:t.row.err_msg,placement:"bottom",effect:"light"}},[s("span",{staticClass:"text-warn"},[e._v("连接失败")])]):2==t.row.con_state?s("span",{staticClass:"text-success"},[e._v("已连接")]):1==t.row.con_state?s("span",{staticClass:"text-info"},[e._v("连接中")]):s("span",{staticClass:"text-info"},[e._v("未连接")])],1):e._e()]}}])}),s("el-table-column",{attrs:{label:"读写",width:"90px"},scopedSlots:e._u([{key:"default",fn:function(t){return[1==t.row.oper_type?s("span",{staticClass:"auth-read"},[e._v("只读")]):s("span",{staticClass:"text-error"},[e._v("读写")])]}}])}),s("el-table-column",{attrs:{label:"创建时间","min-width":"160px"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("dateTime")(t.row.created_at)))]}}])}),s("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[0==t.row.role_id?s("el-button",{attrs:{type:"warning",size:"mini",plain:""},on:{click:function(s){return e.onAdd(t.row.id)}}},[e._v("添加 ")]):e._e(),0!=t.row.role_id?s("el-button",{attrs:{type:"danger",size:"mini",plain:""},on:{click:function(s){return e.onRemove(t.row.id)}}},[e._v("移除 ")]):e._e()]}}])})],1)],2),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{on:{click:e.hide}},[e._v("关闭")])],1)],1)},w=[],g=(s("99af"),s("2909")),k={data:function(){return{db:"all",role:{},ids:"",isShow:!1,search:{db_types:null},con_states:[{k:"0",v:"全部"},{k:"1",v:"连接中"},{k:"2",v:"连接成功"},{k:"3",v:"连接失败"}],rel_types:[{k:"",v:"全部"},{k:"1",v:"已关联"},{k:"2",v:"未关联"}],db_types:[{label:"全部",value:""}].concat(Object(g["a"])([{label:"Oracle",value:"oracle",type:"db",port:1521},{label:"MySql",value:"mysql",type:"db",port:3306},{label:"MsSql",value:"mssql",type:"db",port:1433},{label:"MongoDB",value:"mongodb",type:"db",port:27017},{label:"Mycat",value:"mycat",type:"ds",port:3306},{label:"Redis",value:"redis",type:"db",port:6379}]))}},props:{},watch:{},computed:Object(c["a"])({},Object(d["c"])(["user"])),methods:{onSelect:function(e){console.log("onSelect val:",e);for(var t=[],s=0;s<e.length;s++)t.push(e[s].id);console.log("ids:",t.join(",")),this.ids=t.join(",")},resetSearch:function(){console.log("========resetSearch========="),this.search={},this.search.role_id=this.role.id},refresh:function(){this.$refs.st.search(),this.$emit("refresh")},show:function(e){var t=this;this.role=e,this.search.role_id=e.id,this.search.project=e.project,this.isShow=!0,this.$nextTick((function(){t.refresh()}))},hide:function(e){this.isShow=!1},onBatchAdd:function(){""!=this.ids&&this.onAdd(this.ids)},onBatchRemove:function(){""!=this.ids&&this.onRemove(this.ids)},onAdd:function(e){var t=this;this.$api.role.relationDB(this.role,e).then((function(){t.onSuccess("添加成功"),t.refresh()}))},onRemove:function(e){var t=this;this.$api.role.kickDB(this.role,e).then((function(){t.onSuccess("移除成功"),t.refresh()}))},onSubmit:function(){}},mounted:function(){},components:{}},_=k,y=Object(p["a"])(_,v,w,!1,null,null,null),C=y.exports,x=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-dialog",{attrs:{"append-to-body":"",title:"【"+e.role.name+"】-- 策略",visible:e.isShow,width:"950px"},on:{"update:visible":function(t){e.isShow=t}}},[s("k-search-table",{ref:"st",attrs:{select:"onSelect",url:"/api/role/strategy/page","search-data":e.search,manual:!0},on:{select:e.onSelect,reset:e.resetSearch}},[s("template",{slot:"searchs"},[s("el-form-item",{attrs:{label:"名称",prop:"name"}},[s("el-input",{model:{value:e.search.name,callback:function(t){e.$set(e.search,"name",t)},expression:"search.name"}})],1),s("el-form-item",{attrs:{label:"策略类型:"}},[s("el-select",{attrs:{clearable:!0},model:{value:e.search.type,callback:function(t){e.$set(e.search,"type",t)},expression:"search.type"}},e._l(e.c_types,(function(e){return s("el-option",{key:e.k,attrs:{label:e.v,value:e.k}})})),1)],1)],1),s("template",{slot:"buttons"},[s("el-button",{attrs:{type:"primary",size:"mini",disabled:""==e.ids},on:{click:e.onBatchAdd}},[e._v("批量添加")]),s("el-button",{attrs:{type:"danger",size:"mini",disabled:""==e.ids},on:{click:e.onBatchRemove}},[e._v("批量移除")])],1),s("template",{slot:"columns"},[s("el-table-column",{attrs:{label:"策略名称",prop:"name",width:"280"}}),s("el-table-column",{attrs:{label:"策略类型",prop:"c_type"}}),s("el-table-column",{attrs:{label:"创建时间","min-width":"160px"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("dateTime")(t.row.created_at)))]}}])}),s("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[0==t.row.role_id?s("el-button",{attrs:{type:"warning",size:"mini",plain:""},on:{click:function(s){return e.onAdd(t.row.id)}}},[e._v("添加 ")]):e._e(),0!=t.row.role_id?s("el-button",{attrs:{type:"danger",size:"mini",plain:""},on:{click:function(s){return e.onRemove(t.row.id)}}},[e._v("移除 ")]):e._e()]}}])})],1)],2),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{on:{click:e.hide}},[e._v("关闭")])],1)],1)},L=[],D={data:function(){return{role:{},ids:"",isShow:!1,search:{db_types:null},con_states:[{k:"0",v:"全部"},{k:"1",v:"连接中"},{k:"2",v:"连接成功"},{k:"3",v:"连接失败"}],rel_types:[{k:"",v:"全部"},{k:"1",v:"已关联"},{k:"2",v:"未关联"}],c_types:[{k:"",v:"全部"},{k:"select",v:"查询"},{k:"update",v:"更新"}]}},props:{},watch:{},computed:Object(c["a"])({},Object(d["c"])(["user"])),methods:{onSelect:function(e){console.log("onSelect val:",e);for(var t=[],s=0;s<e.length;s++)t.push(e[s].id);console.log("ids:",t.join(",")),this.ids=t.join(",")},resetSearch:function(){console.log("========resetSearch========="),this.search={},this.search.role_id=this.role.id},refresh:function(){this.$refs.st.search(),this.$emit("refresh")},show:function(e){var t=this;this.role=e,this.search.role_id=e.id,this.isShow=!0,this.$nextTick((function(){t.refresh()}))},hide:function(e){this.isShow=!1},onBatchAdd:function(){""!=this.ids&&this.onAdd(this.ids)},onBatchRemove:function(){""!=this.ids&&this.onRemove(this.ids)},onAdd:function(e){var t=this;this.$api.role.relationStrategy(this.role,e).then((function(){t.onSuccess("添加成功"),t.refresh()}))},onRemove:function(e){var t=this;this.$api.role.kickStrategy(this.role,e).then((function(){t.onSuccess("移除成功"),t.refresh()}))},onSubmit:function(){}},mounted:function(){},components:{}},S=D,$=Object(p["a"])(S,x,L,!1,null,null,null),j=$.exports,q=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-dialog",{attrs:{"before-close":e.hide,"append-to-body":"","custom-class":"database-edit",title:e.id?"编辑项目角色":"新建项目角色",visible:e.isShow,width:"600px"},on:{"update:visible":function(t){e.isShow=t}}},[s("el-form",{attrs:{model:e.formData,"label-width":"120px"}},[s("el-form-item",{attrs:{label:"所属项目"}},[s("h3",[e._v(e._s(e.p.name))])]),s("el-form-item",{attrs:{label:"角色名"}},[s("el-tooltip",{attrs:{placement:"top",content:"角色名称，项目内不可重复"}},[s("el-input",{attrs:{"auto-complete":"off"},model:{value:e.formData.name,callback:function(t){e.$set(e.formData,"name",t)},expression:"formData.name"}})],1)],1),s("el-form-item",{attrs:{label:"说明"}},[s("el-tooltip",{attrs:{placement:"top",content:"角色说明"}},[s("el-input",{attrs:{type:"textarea"},model:{value:e.formData.info,callback:function(t){e.$set(e.formData,"info",t)},expression:"formData.info"}})],1)],1)],1),s("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("k-btn-tip",{directives:[{name:"show",rawName:"v-show",value:e.formData.id,expression:"formData.id"}],attrs:{tip:"确定要删除该项目角色【"+e.formData.name+"】?"},on:{click:function(t){return e.onRemove(e.formData.id)}}},[s("el-button",{attrs:{type:"danger"}},[e._v("删除")])],1),s("el-button",{attrs:{type:"primary"},on:{click:e.onSubmit}},[e._v("确 定")])],1)],1)},A=[],O={data:function(){return{id:"",isShow:!1,formData:this.reset(),p:{}}},props:{},watch:{},computed:Object(c["a"])({},Object(d["c"])(["user"])),methods:{reset:function(){return{id:"",name:"",info:"",role_type:1}},show:function(e){this.formData=this.reset(),e.r&&e.r.id&&(this.id=e.r.id,this.formData=e.r),e.p&&e.p.id&&(this.p=e.p,this.formData.project=e.p.id),this.isShow=!0},hide:function(e){this.formData=this.reset(),this.id="",this.isShow=!1},onRemove:function(e){var t=this;this.$api.role.remove(e).then((function(e){t.onSuccess("删除成功"),t.hide(),t.$emit("refresh")}))},onSubmit:function(){var e=this,t=h["cloneDeep"](this.formData);if(!t.name)return this.$message({message:"角色名称不能为空",type:"warning"}),!1;this.$api.role.save(t).then((function(t){e.onSuccess("提交成功"),e.hide(),e.$emit("refresh")}))}},mounted:function(){},components:{}},T=O,R=Object(p["a"])(T,q,A,!1,null,null,null),I=R.exports,B=s("5c96"),E={data:function(){return{input3:"",filterType:"角色名",role:null,role_name:"",project_name:null,filterText:"",dataList:[],projectList:[],treeProps:{label:"name"}}},props:["project_id","project"],watch:{filterText:function(e){this.$refs.roleList.filter(e)},filterType:function(e){this.$refs.roleList.filter(this.filterText)},project_id:function(e){console.log("rolelist project_id has change ",e),this.refresh(e)}},methods:{showAddRole:function(){this.project?this.$refs.roleDialog.show({p:this.project}):B["Message"].error({title:"请求",message:"请选择当前项目！",type:"error",duration:2e3})},selItem:function(e){console.log("[role.list methods] selItem：",e),this.$emit("on-project",e)},onEdit:function(e){this.$refs.roleDialog.show({r:e,p:this.project})},filterNode:function(e,t){if(!e)return!0;if("用户名"==this.filterType){if(t.name==this.role_name)return!0;if(""!=t.user_names){var s=t.user_names.split(",");for(var a in s)if(-1!==s[a].toLowerCase().indexOf(e.toLowerCase()))return!0}return!1}if("数据源"==this.filterType){if(t.name==this.role_name)return!0;if(""!=t.db_names){var i=t.db_names.split(",");for(var o in i)if(-1!==i[o].toLowerCase().indexOf(e.toLowerCase()))return!0}return!1}return t.name==this.role_name||-1!==t.name.toLowerCase().indexOf(e.toLowerCase())},refresh:function(e){var t=this;console.log("rolelist refresh ",e),this.role={},e||(e=this.project.id),e?this.$api.role.all(1,e).then((function(e){if(e&&e.length>0){for(var s=0;s<e.length;s++)e[s].edit=!1,e[s].tname=e[s].name;t.role=e[0]}t.dataList=e,t.role&&t.role.id?(t.$emit("role",t.role),t.$nextTick((function(){t.$refs.roleList.setCurrentKey(t.role.id)}))):(t.role={},t.$emit("role",{}))})):(this.role={},this.$emit("role",{}))},onRemove:function(e){var t=this;this.$api.role.remove(e.id).then((function(e){t.onSuccess("删除成功"),t.refresh()}),(function(e){B["Message"].error({title:"请求",message:e&&e.data?e.data:e,type:"error",duration:2e3})}))},onClick:function(e){this.role=e,this.role_name=e.name,this.$emit("role",e)}},components:{DialogUser:b,DialogDb:C,DialogRole:I,DialogStrategy:j},mounted:function(){this.refresh(this.project_id)}},P=E,N=(s("71a7"),Object(p["a"])(P,o,n,!1,null,null,null)),z=N.exports,H=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("k-card",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{head:"数据源/数据库/数据集"}},[s("span",[s("el-input",{attrs:{size:"small",placeholder:"输入关键字进行过滤数据库",clearable:""},model:{value:e.filterText,callback:function(t){e.filterText=t},expression:"filterText"}})],1),s("template",{slot:"tools"},[s("el-button",{attrs:{type:"primary",size:"mini"},on:{click:e.refresh}},[e._v("刷新")])],1),s("div",{staticClass:"role-instance-list"},[s("el-collapse",{directives:[{name:"loading",rawName:"v-loading",value:e.dbloading,expression:"dbloading"}],on:{change:e.onSourceOpenChange},model:{value:e.activeId,callback:function(t){e.activeId=t},expression:"activeId"}},e._l(e.sourceList,(function(t,a){return s("el-collapse-item",{key:a,attrs:{name:t.id}},[s("template",{slot:"title"},[e._v(" "+e._s(t.label)+" ")]),s("div",{staticClass:"item hbox-between no-user-select"},[s("div",{staticClass:"left"},[s("el-checkbox",{attrs:{indeterminate:e.isIndeterminate(t),value:e.isCheckAll(t.id)},on:{change:function(s){return e.checkAllChangeHandler(s,t)}}},[e._v("全选")])],1),s("div",{staticClass:"center",staticStyle:{"font-size":"12px"}}),s("div",{staticClass:"right all pointer-active",attrs:{title:"批量设置"},on:{click:function(s){return e.openBatchDialog(t)}}},[e._v(" 批量设置 ")])]),e._l(e.filterDatabases[t.id],(function(a,i){return s("div",{key:i,staticClass:"db-row"},[s("div",{staticClass:"item hbox-between",class:{active:e.activeIndex==t.id+"_"+i},on:{click:function(s){return e.onClick(a,t,i)}}},[s("div",{staticClass:"left flex-over"},[s("span",{on:{click:function(e){e.stopPropagation()}}},[s("el-checkbox",{attrs:{value:e.isDbSelect(t.id,a.label)},on:{change:function(s){return e.onCheckDb(s,a,t)}}})],1),s("span",{class:{"auth-read":1==a.rw,"auth-write":2==a.rw,"auth-disable":3==a.rw,"auth-manage":4==a.rw}},[e._v(" "+e._s(a.label)+" ")])]),s("div",{staticClass:"right"},[s("i",{staticClass:"sn-font pointer-active",class:{"auth-read":1==a.rw},attrs:{title:"读权限"},on:{click:function(s){return e.onAuthOwner(a,t,1)}}},[e._v("读")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-write":2==a.rw},attrs:{title:"写权限"},on:{click:function(s){return e.onAuthOwner(a,t,2)}}},[e._v("写")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-manage":4==a.rw},attrs:{title:"管理权限"},on:{click:function(s){return e.onAuthOwner(a,t,4)}}},[e._v("管")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-disable":3==a.rw},attrs:{title:"禁用权限"},on:{click:function(s){return e.onAuthOwner(a,t,3)}}},[e._v("禁")]),e._v(" ( "),s("i",{staticClass:"sn-font pointer-active",class:{"auth-read":1==a.aq},attrs:{title:"异步查询权限"},on:{click:function(s){return e.onAuthOwnerAsync(a,t,"aq")}}},[e._v("")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-read":1==a.ae},attrs:{title:"数据导出/异步导出权限"},on:{click:function(s){return e.onAuthOwnerAsync(a,t,"ae")}}},[e._v("")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-read":1==a.as},attrs:{title:"SQL导出权限"},on:{click:function(s){return e.onAuthOwnerAsync(a,t,"as")}}},[e._v("")]),e._v(" ) ")])])])}))],2)})),1)],1),s("dialog-batchauth",{ref:"dialogBatchauthRef",attrs:{"confirm-loading":!0},on:{confirm:e.onBatchConfirm}})],2)},K=[],M=(s("4160"),s("caad"),s("d3b7"),s("07ac"),s("2532"),s("3ca3"),s("159b"),s("ddb0"),function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-dialog",{directives:[{name:"dialogDrag",rawName:"v-dialogDrag"},{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"dialog-labels",attrs:{"append-to-body":!0,visible:e.visible},on:{"update:visible":function(t){e.visible=t},close:e.closeHandle}},[s("div",{staticClass:"headers",attrs:{slot:"title"},slot:"title"},[s("div",[e._v(e._s(e.headers.title))]),s("div",{staticClass:"target-text"},[e._v(e._s(e.headers.targetText))]),s("div")]),s("el-row",{attrs:{gutter:20}},[s("el-col",{attrs:{span:5,offset:0}},[e._v(" 读/写/管/禁： ")]),s("el-col",{attrs:{span:19,offset:0}},[s("el-radio-group",{model:{value:e.authObj.rw,callback:function(t){e.$set(e.authObj,"rw",t)},expression:"authObj.rw"}},[s("el-radio",{staticClass:"auth-1",attrs:{disabled:e.getRwInfo(1).disable,title:e.getRwInfo(1).title,label:1}},[e._v("读")]),s("el-radio",{staticClass:"auth-2",attrs:{disabled:e.getRwInfo(2).disable,title:e.getRwInfo(2).title,label:2}},[e._v("写")]),s("el-radio",{staticClass:"auth-4",attrs:{disabled:e.getRwInfo(4).disable,title:e.getRwInfo(4).title,label:4}},[e._v("管")]),s("el-radio",{staticClass:"auth-3",attrs:{disabled:e.getRwInfo(3).disable,title:e.getRwInfo(3).title,label:3}},[e._v("禁")])],1)],1)],1),s("hr",{staticClass:"hr margin-y-12"}),s("el-row",{attrs:{gutter:20}},[s("el-col",{attrs:{span:5,offset:0}},[e._v(" 异步查询 "),s("i",{staticClass:"sn-font",class:{"auth-icon-set":1===e.authObj.aq,"auth-icon-ignore":-1==e.authObj.aq}},[e._v("")])]),s("el-col",{attrs:{span:19,offset:0}},[s("el-checkbox",{attrs:{disabled:0==e.owner.aq,"true-label":1,"false-label":0},model:{value:e.authObj.aq,callback:function(t){e.$set(e.authObj,"aq",t)},expression:"authObj.aq"}})],1)],1),s("el-row",{attrs:{gutter:20}},[s("el-col",{attrs:{span:5,offset:0}},[e._v(" 数据导出 "),s("i",{staticClass:"sn-font",class:{"auth-icon-set":1===e.authObj.ae,"auth-icon-ignore":-1==e.authObj.ae}},[e._v("")])]),s("el-col",{attrs:{span:19,offset:0}},[s("el-checkbox",{attrs:{disabled:0==e.owner.ae,"true-label":1,"false-label":0},model:{value:e.authObj.ae,callback:function(t){e.$set(e.authObj,"ae",t)},expression:"authObj.ae"}})],1)],1),s("el-row",{attrs:{gutter:20}},[s("el-col",{attrs:{span:5,offset:0}},[e._v(" SQL导出 "),s("i",{staticClass:"sn-font",class:{"auth-icon-set":1===e.authObj.as,"auth-icon-ignore":-1==e.authObj.as}},[e._v("")])]),s("el-col",{attrs:{span:19,offset:0}},[s("el-checkbox",{attrs:{disabled:0==e.owner.as,"true-label":1,"false-label":0},model:{value:e.authObj.as,callback:function(t){e.$set(e.authObj,"as",t)},expression:"authObj.as"}})],1)],1),s("el-row",{staticClass:"margin-top-12",attrs:{gutter:20}},[s("el-col",{attrs:{span:24,offset:0}},[e._v(" 共选择 "+e._s(e.nodeList.length)+" 条数据 ")])],1),s("el-row",{staticClass:"label-list ",attrs:{gutter:20}},e._l(e.nodeList,(function(t,a){return s("el-col",{key:a,attrs:{span:24,offset:0}},[e._v(" "+e._s(t.label)+" ")])})),1),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{on:{click:e.cancel}},[e._v("取 消")]),s("el-button",{attrs:{type:"primary"},on:{click:e.confirm}},[e._v("确定")])],1)],1)}),Q=[],J={props:{confirmLoading:{type:Boolean,default:function(){return!1}}},data:function(){return{headers:{title:"设置权限",targetText:""},visible2:!1,visible:!1,loading:!1,owner:{},authObj:{rw:1,aq:0,ae:0,as:0,aw:0},nodeList:[]}},methods:{setHeaders:function(e){this.headers=e},getRwInfo:function(e){var t=[1,2,3,4];3==this.owner.rw||""==this.owner.rw||-1==this.owner.rw?t=[]:1==this.owner.rw?t=[1,3]:2==this.owner.rw&&(t=[1,2,3]);var s=-1==t.indexOf(e);return{disable:s,title:s?"上级权限导致不可用":""}},confirm:function(){this.loading=this.confirmLoading,this.$emit("confirm",this.authObj)},setLoading:function(e){this.loading=Boolean(e)},hide:function(){this.loading=!1,this.visible=!1},cancel:function(){this.visible=!1},closeHandle:function(){this.nodeList=[],this.authObj={rw:1,aq:0,ae:0,as:0,aw:0},console.log("关闭： ",this.authObj)},show:function(e,t){var s=new Array(e.length);for(var a in e){var i=e[a],o={aq:i.aq,ae:i.ae,as:i.as,aw:i.aw,rw:i.rw,label:i.label,leaf:i.leaf};s[a]=o}this.owner={aq:t.aq,ae:t.ae,as:t.as,aw:t.aw,rw:t.rw,label:t.label,leaf:t.leaf},this.authObj={rw:t.rw,aq:t.aq,ae:t.ae,as:t.as,aw:t.aw},this.visible=!0,this.nodeList=s},trigger:function(){this.visible=!this.visible}}},U=J,F=(s("30ae"),Object(p["a"])(U,M,Q,!1,null,null,null)),Y=F.exports,G={components:{"dialog-batchauth":Y},data:function(){return{activeId:null,activeIndex:-1,batchSource:{},selectedNodeList:[],checkedDatas:{},dbloading:!1,loading:!1,cur_name:"",filterText:"",sourceList:[],sources:{},databases:{},role:{},treeProps:{id:"id",label:"label",isLeaf:"leaf"}}},props:["project_id","project"],computed:{filterDatabases:function(){var e=this,t=this.databases,s={};for(var a in t){var i=t[a],o=i.filter((function(t){return t.label.toLowerCase().includes(e.filterText.toLowerCase())}));s[a]=o}return s},isIndeterminate:function(){var e=this;return function(t){return!h["isEmpty"](e.checkedDatas[t.id])&&!e.isCheckAll(t.id)}},isCheckAll:function(){var e=this;return function(t){if(h["isEmpty"](e.checkedDatas[t]))return!1;var s=Object.keys(e.checkedDatas[t]),a=Object.keys(e.databases[t]);return s.length==a.length&&(console.log("选中全部："),!0)}},isDbSelect:function(){var e=this;return function(t,s){if(h["isEmpty"](e.checkedDatas[t]))return!1;var a=Object.keys(e.checkedDatas[t]);return a.includes(s)}}},mounted:function(){this.activeIndex=-1},methods:{checkAllChangeHandler:function(e,t){if(e){var s=this.databases[t.id],a={};s.forEach((function(e){a[e.label]=e})),this.$set(this.checkedDatas,t.id,a)}else this.$set(this.checkedDatas,t.id,{})},onSourceOpenChange:function(e){e=e instanceof Array?e[e.length-1]:e,e?this.getDatabse(e):console.log("收起数据源：",e)},getDatabse:function(e){this.databases[e]||this.onNextLoad(this.sources[e])},onCheckDb:function(e,t,s){if(console.log(e,t),e){if(this.checkedDatas[s.id])this.$set(this.checkedDatas[s.id],t.label,t);else{var a={};a[t.label]=t,this.$set(this.checkedDatas,s.id,a)}console.log("选中：",this.checkedDatas[s.id])}else{if(!this.checkedDatas[s.id]||!this.checkedDatas[s.id][t.label])return!1;console.log("取消"),this.$delete(this.checkedDatas[s.id],t.label)}},openBatchDialog:function(e){if(!this.checkedDatas||!this.checkedDatas[e.id]||0==Object.keys(this.checkedDatas[e.id]).length)return this.$message({message:"请勾选相应数据源下的数据库",type:"warning"}),!1;var t=this.checkedDatas[e.id];console.log("批量内容：",Object.values(t),e);var s=Object(c["a"])(Object(c["a"])({},e),{},{aq:1,ae:1,as:1});this.batchSource=e,this.$refs.dialogBatchauthRef.show(Object.values(t),s),this.$refs.dialogBatchauthRef.setHeaders({title:"设置权限",targetText:"数据源："+e.label})},onBatchConfirm:function(e){var t=this;console.log("[instance.list.vue] 批量设置数据库权限 - 参数：",e);var s=this.checkedDatas[this.batchSource.id],a=Object.values(s),i=[];a.forEach((function(s){i.push(t.addPermission2(t.batchSource.id,"*",s.label,-1==e.rw?s.rw:e.rw,-1==e.aq?s.aq:e.aq,-1==e.ae?s.ae:e.ae,-1==e.as?s.as:e.as,""))})),Promise.all(i).then((function(t){console.log("批量设置结果：",t);for(var s=0;s<a.length;s++)-1!=e.rw&&(a[s].rw=e.rw),-1!=e.ae&&(a[s].ae=e.ae),-1!=e.aq&&(a[s].aq=e.aq),-1!=e.as&&(a[s].as=e.as)})).catch((function(e){console.log("批量设置结果：error",e)})).finally((function(){t.$refs.dialogBatchauthRef.hide(),t.$emit("refresh-next","owner")}))},addPermission2:function(e){var t=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,i=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0,n={roleId:this.role.id,dbId:e,tname:"*",towner:t,rw:s,aq:a,ae:i,as:o,type:"",project:this.project_id};return this.$api.permission.addPermission(n)},doRefresh:function(e){e?(this.role=e,this.refresh()):(this.role={},this.sourceList=[],this.activeId=null,this.databases={},this.checkedDatas={},this.sourceList2Sources())},filterNode:function(e,t){return!e||(!!t.leaf||(t.label==this.cur_name||(console.log("data.label:",t.label,"  value:",e,"  tolower:",t.label.toLowerCase()),-1!==t.label.toLowerCase().indexOf(e.toLowerCase()))))},showRw:function(e){return 1==e?"只读":2==e?"读写":4==e?"管理":3==e?"禁用":"未知"},refresh:function(){var e=this;console.log("[instance.list methods] refresh..."),this.role&&this.role.id?this.$api.permission.permissionDB(this.role.id).then((function(t){e.sourceList=t})).finally((function(){e.checkedDatas={},e.sourceList2Sources(),e.activeId=null,e.databases={},e.sourceList.forEach((function(t){e.getDatabse(t.id)}))})):(this.sourceList=[],this.activeId=null,this.databases={},this.sourceList2Sources(),this.checkedDatas={})},sourceList2Sources:function(){var e={};this.sourceList.forEach((function(t){e[t.id]=t})),this.sources=e},onClick:function(e,t,s){if(console.log("[instance.list methods] onClick data:",e,"   db:",t),this.activeIndex="".concat(t.id,"_").concat(s),e.leaf){if(!t.rw)return this.$emit("owner",{}),void this.onError("请选授权数据仓库");this.cur_name=t.label,e.db=t,e.db_type=t.db_type,this.$emit("owner",e)}},onAuthDBAsync:function(e,t){var s=this,a="",i="",o=0;if(console.log("db:",e.id," db.ae:",e.ae,"db.aq:",e.aq,"  t:",t),!e.rw)return this.$emit("owner",{}),void this.onError("请选授权数据仓库");if(3!=e.rw){if("aw"==t)i="工单流程",1==e.aw?(e.aw=0,a="取消"):(e.aw=1,a="设置"),o=e.aw;else if("ae"==t){if(i="文件导出",!e.hasAsynExport&&0==e.ae)return void this.onError("该数据源不支持导出操作！");1==e.ae?(e.ae=0,a="取消"):(e.ae=1,a="设置"),o=e.ae}else if("aq"==t){if(i="异步查询",!e.hasAsynQuery&&0==e.aq)return void this.onError("该数据源不支持异步查询操作！");1==e.aq?(e.aq=0,a="取消"):(e.aq=1,a="设置"),o=e.aq}else if("as"==t){if(i="导出Sql",!e.hasAsynSql&&0==e.as)return void this.onError("该数据源不支持导出ql操作！");1==e.as?(e.as=0,a="取消"):(e.as=1,a="设置"),o=e.as}this.$api.permission.addAsyncPermission(this.role.id,e.id,"*","*",e.rw,t,o,this.project_id).then((function(t){var o=a+i+"成功";s.onSuccess(o),console.log("down:",e.id," ae:",e.ae,"  aq:",e.aq),e.rw&&-1!=e.rw?(e.ae=t.asyn_export,e.aq=t.asyn_query,e.as=t.asyn_sql,e.aw=t.audit_work):(e.ae=0,e.aq=0,e.as=0,e.aw=0),e&&e.children&&e.children.forEach((function(t){t.ae=e.ae,t.as=e.as,t.aq=e.aq,t.aw=e.aw}))}))}},onAuthOwnerAsync:function(e,t,s){var a=this,i=0;if(console.log("db:",t.id," db.ae:",t.ae,"db.aq:",t.aq,"  t:",s),!t.rw)return this.$emit("owner",{}),void this.onError("请选授权数据仓库");if(3!=t.rw&&3!=e.rw){if("aw"==s&&("工单流程",1==e.aw?(e.aw=0,"取消"):(e.aw=1,"设置"),i=e.aw),"ae"==s){if("文件导出",!t.hasAsynExport&&0==e.ae)return void this.onError("该实例所在数据源不支持导出操作！");1==e.ae?(e.ae=0,"取消"):(e.ae=1,"设置"),i=e.ae}if("aq"==s){if("异步查询",!t.hasAsynQuery&&0==e.aq)return void this.onError("该实例所在数据源不支持异步查询操作！");1==e.aq?(e.aq=0,"取消"):(e.aq=1,"设置"),i=e.aq}if("as"==s){if("导出Sql",!t.hasAsynSql&&0==e.as)return void this.onError("该实例所在数据源不支持导出Sql操作！");1==e.as?(e.as=0,"取消"):(e.as=1,"设置"),i=e.as}this.$api.permission.addAsyncPermission(this.role.id,t.id,e.label,"*",e.rw,s,i,this.project_id).then((function(t){var s="操作成功";a.onSuccess(s),e.rw&&-1!=e.rw?(e.ae=t.asyn_export,e.aq=t.asyn_query,e.as=t.asyn_sql,e.aw=t.audit_work):(e.ae=0,e.aq=0,e.as=0,e.aw=0),a.$emit("db",3==e.rw||-1==e.rw?{}:e)})).finally((function(){a.$emit("refresh-next","owner")}))}},onAuthOwner:function(e,t,s){var a=this;e.rw==s&&(s=t.rw),-1!=t.rw&&""!=t.rw&&3!=t.rw&&(1==t.rw&&2==s||(1!=s&&2!=s||(e.real_rw=s),this.$api.permission.addOwner(this.role.id,t.id,e.label,s,this.project_id).then((function(t){var i="操作成功";3==s?i="设置禁用成功":1==s?i="设置只读成功":2==s?i="设置读写成功":-1==s&&(i="取消设置成功"),a.onSuccess(i),e.rw&&-1!=e.rw?(e.ae=t.asyn_export,e.aq=t.asyn_query,e.as=t.asyn_sql,e.aw=t.autit_work):(e.ae=0,e.aq=0,e.as=0,e.aw=0),e.rw=s,a.$emit("db",3==s?{}:e),a.$emit("refresh-next","owner")}))))},onAuthDBChk:function(e){var t=this;e.chk=!e.chk;e.chk,this.loading=!0,this.$api.permission.addDBChild(this.role.id,e.id,e.chk,this.project_id).then((function(s){console.log("db.rw:",e.rw," db.asyn_export:",e.asyn_export,"  db.asyn_query:",e.asyn_query);var a="";a=e.chk?"批量禁用成功":"批量取消禁用成功",t.onSuccess(a),e&&e.children&&e.children.forEach((function(t){console.log("owner.rw:",t.rw,"   db.rw:",e.rw),e.chk?t.rw=3:t.rw=e.rw})),t.loading=!1})).catch((function(){t.loading=!1}))},onAuthDB:function(e,t){var s=this;console.log("db.rw:",e.rw,"   rw:",t),e.rw==t&&(t=-1),1!=e.operType||2!=t&&4!=t?2!=e.operType||4!=t?(e.rw=t,this.$api.permission.addDB(this.role.id,e.id,e.rw,this.project_id).then((function(a){e.rw&&-1!=e.rw?(e.ae=a.asyn_export,e.aq=a.asyn_query,e.as=a.asyn_sql,e.aw=a.audit_work):(e.ae=0,e.aq=0,e.as=0,e.aw=0),console.log("db.rw:",e.rw," db.asyn_export:",e.asyn_export,"  db.asyn_query:",e.asyn_query);var i="操作成功";3==t?i="设置禁用成功":1==t?i="设置只读成功":2==t?i="设置读写成功":4==t?i="设置管理成功":-1==t&&(i="取消设置成功"),s.onSuccess(i),e&&e.children&&e.children.forEach((function(t){console.log("owner.rw:",t.rw,"   db.rw:",e.rw),3!=e.rw&&-1!=e.rw||(t.real_rw=""),1==e.rw||3==e.rw||-1==e.rw?t.rw=e.rw:t.rw=t.real_rw||e.rw,t.ae=e.ae,t.aq=e.aq,t.as=e.as,t.aw=e.aw}))}))):this.onError("该数据源仅支持读写操作！"):this.onError("该数据源仅支持只读操作！")},onNextLoad:function(e){var t=this;if(e.id){console.log("加载子节点：",e),this.dbloading=!0;var s=Date.now();this.$api.permission.allOwner(this.role.id,e.id,e).then((function(s){t.$set(t.databases,e.id,s)})).finally((function(){var e=Date.now(),a=s-e+300;a>=0?setTimeout((function(){t.$nextTick((function(){t.dbloading=!1}))}),a):t.dbloading=!1}))}}}},V=G,W=(s("3371"),Object(p["a"])(V,H,K,!1,null,null,null)),X=W.exports,Z=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("k-cardx",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"file-table-list",attrs:{head:"数据表",isTypes:"redis"!=e.owner.db_type,db_type:e.owner.db_type},on:{sel:e.selItem}},[s("span",[s("el-input",{attrs:{size:"small",placeholder:"输入关键字进行过滤",clearable:""},model:{value:e.filterText,callback:function(t){e.filterText=t},expression:"filterText"}})],1),s("template",{slot:"tools"},[s("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){return e.refresh(null,!0)}}},[e._v("刷新")])],1),s("div",{staticClass:"role-table-list"},[e.owner&&e.vnodeList&&e.vnodeList.length>0?s("div",{staticClass:"item hbox-between"},[s("div",{staticClass:"left"},[s("el-checkbox",{attrs:{indeterminate:e.isIndeterminate},on:{change:function(t){return e.checkAllChangeHandler(t,!0)}},model:{value:e.isCheckAll,callback:function(t){e.isCheckAll=t},expression:"isCheckAll"}},[e._v("全选")])],1),s("div",{staticClass:"center",staticStyle:{"font-size":"12px"}},[e._v(" "+e._s(e.pages.nodeLength)+"/"+e._s(e.pages.total)+" ")]),3!=e.owner.rw?s("div",{staticClass:"right all pointer-active",attrs:{title:"批量设置"},on:{click:e.batchClickHandle}},[e._v(" 批量设置 ")]):e._e()]):e._e(),e.filterDataList.length>0?s("virtual-list",{ref:"table-vlist",staticClass:"table-vlist",attrs:{"data-key":"label","estimate-size":e.itemHeight,keeps:e.vlistKeeps,"data-sources":e.filterDataList,"data-component":e.vlistTemplate,"extra-props":{selectedNodeList:e.selectedNodeList,selectedItemLabel:e.selectedItemLabel}},on:{tobottom:e.onScrollToBottom}},[s("div",{staticClass:"loading-spinner no-user-select",attrs:{slot:"footer"},slot:"footer"},[e._v("结束.")])]):s("div",{ref:"table-vlist",staticClass:"empty"},[e._v(" "+e._s(e.emptyText)+" ")])],1),s("dialog-batchauth",{ref:"dialogBatchauthRef",attrs:{"confirm-loading":!0},on:{confirm:e.onBatchConfirm}})],2)},ee=[],te=(s("498a"),s("89c1")),se=s.n(te),ae=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"vlist-item-template item",class:{"item-selected":e.selectedItemLabel==e.source.label}},[s("div",{staticClass:"left"},[s("el-checkbox",{staticClass:"check-box",attrs:{value:e.isSelected},on:{change:e.checkboxChangeHandle}}),s("span",{staticClass:"source-label pointer-default",class:[e.clazz],attrs:{title:e.source.label},on:{click:e.onItemClick}},[e._v(e._s(e.source.label))])],1),s("div",{staticClass:"right"},[s("i",{staticClass:"sn-font pointer-active",class:{"auth-read":1==e.source.rw},on:{click:function(t){return t.stopPropagation(),e.authClickHandle("auth",1)}}},[e._v(" 读 ")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-write":2==e.source.rw},on:{click:function(t){return t.stopPropagation(),e.authClickHandle("auth",2)}}},[e._v("写")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-manage":4==e.source.rw},on:{click:function(t){return t.stopPropagation(),e.authClickHandle("auth",4)}}},[e._v("管")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-disable":3==e.source.rw},on:{click:function(t){return t.stopPropagation(),e.authClickHandle("auth",3)}}},[e._v("禁")]),[e._v(" ( "),s("i",{staticClass:"sn-font pointer-active",class:[e.getAuth2("aq")],on:{click:function(t){return t.stopPropagation(),e.authClickHandle("auth2","aq")}}},[e._v("")]),s("i",{staticClass:"sn-font pointer-active",class:[e.getAuth2("ae")],on:{click:function(t){return t.stopPropagation(),e.authClickHandle("auth2","ae")}}},[e._v("")]),s("i",{staticClass:"sn-font",class:[e.getAuth2("as")],on:{click:function(t){return t.stopPropagation(),e.authClickHandle("auth2","as")}}},[e._v("")]),e._v(" ) ")]],2)])},ie=[],oe=s("2708"),ne={name:"vlist-template",mixins:[oe["a"]],props:{selectedItemLabel:{},selectedNodeList:{type:Array,default:function(){return[]}},source:{type:Object,default:function(){return{}}}},computed:{getAuth2:function(){var e=this;return function(t){return 1==e.source[t]?"auth-read":""}},isSelected:function(){var e=!1;for(var t in this.selectedNodeList){var s=this.selectedNodeList[t];if(s.label==this.source.label){e=!0;break}}return e},clazz:function(){return this.getAuth()}},data:function(){return{nodeData:this.source}},methods:{authClickHandle:function(e,t){if("auth"==e)this.dispatch("role-table-list","vnode-change",{type:"change-auth",source:this.source,auth:{key:"rw",value:t}});else if("auth2"==e){var s=1==this.source[t]?0:1;this.dispatch("role-table-list","vnode-change",{type:"change-auth2",source:this.source,auth:{key:t,value:s}})}},getAuth:function(){var e="";switch(this.source.rw){case 1:e="auth-read";break;case 2:e="auth-write";break;case 3:e="auth-disable";break;case 4:e="auth-manage";break}return e},checkboxChangeHandle:function(e){this.dispatch("role-table-list","vnode-change",{type:"checked-item",source:this.source,e:e})},onItemClick:function(){this.dispatch("role-table-list","vnode-change",{type:"selected-line",source:this.source})}}},le=ne,re=(s("e635"),Object(p["a"])(le,ae,ie,!1,null,"275993e0",null)),ce=re.exports,he=s("ac9c"),de=s("163b"),ue={name:"role-table-list",data:function(){return{vlistTemplate:ce,vlistKeeps:24,itemHeight:26,selectedNodeList:[],selectedItemLabel:"",pages:{no:0,size:100,total:0,nodeLength:0},vnodeList:[],emptyText:"请选择数据实例",isCheckAll:!1,isIndeterminate:!1,tooltipAsync:"",confirmAsync:!1,checked:{},check_rw:-1,type:"table",cur_name:"",filterText:"",loading:!1,def_checks:[],ids:[],dataList:[],treeProps:{id:"id",label:"label",isLeaf:"leaf"}}},props:{role:{},owner:{},project:{}},computed:{filterDataList:function(){var e=this;return""==this.filterText.trim()?this.vnodeList:h["filter"](this.vnodeList,(function(t){return-1!=t.label.toUpperCase().indexOf(e.filterText.toUpperCase())}))}},watch:{owner:{handler:function(e){console.log("[table.list watch] owner:",e),this.emptyText="请选择数据实例",this.refresh(null,!0)}}},methods:{batchClickHandle:function(){this.selectedNodeList.length>0?(this.$refs.dialogBatchauthRef.show(this.selectedNodeList,this.owner),this.$refs.dialogBatchauthRef.setHeaders({title:"设置权限",targetText:"数据库："+(this.owner&&this.owner.label)})):this.$message({message:"请勾选数据表",type:"warning"})},onScrollToBottom:function(){this.loading?console.info("[table.list methods] onScrollToBottom() 防止多次查询"):this.pages.cursor?(this.pages.no=this.pages.cursor,console.log("[table.list methods] onScrollToBottom：",this.pages),this.refresh(null,!1)):this.loading=!1},checkAllChangeHandler:function(e,t){t&&e?(console.log("全选",this.vnodeList.length),this.selectedNodeList=this.vnodeList):(console.log("取消全选"),this.selectedNodeList=[]),this.setCheckAllBox()},selItem:function(e){this.type=e,this.refresh(null,!0)},filterNode:function(e,t){return!e||(t.label==this.cur_name||(console.log("data.label:",t.label,"  value:",e),-1!==t.label.toLowerCase().indexOf(e.toLowerCase())))},vlistToTop:function(){this.$refs["table-vlist"]&&this.$refs["table-vlist"].scrollToIndex&&this.$refs["table-vlist"].scrollToIndex(0)},vlistReset:function(){this.$refs["table-vlist"]&&this.$refs["table-vlist"].reset&&this.$refs["table-vlist"].reset()},refresh:function(e,t){var s=this;if(this.role.id&&this.owner.id){console.log("[table.list methods] refresh：",e,t),this.checked=this.owner;var a={roleId:this.role.id,dbId:this.owner.db.id,tableName:this.owner.label,owner:this.owner,type:this.type,pageSize:this.pages.size,pageNo:this.pages.no};e&&de["a"].has(e,["f","type"])&&(console.log("[card.db methods] onChangeDB 自带config参数：",e),a=Object.assign(a,e)),this.loading=!0,this.$api.permission.allTable(a.roleId,a.dbId,a.tableName,a.owner,a.type,null,null,a.pageNo,a.pageSize,a.f,!0).then((function(e){console.info("dataList: dataList",e,t),t||a.f?(console.log("强制刷新..."),s.vlistReset(),s.vnodeList=e.list,s.selectedNodeList=[],s.isIndeterminate=!1,s.vlistReset()):s.vnodeList=s.vnodeList.concat(e.list),s.check_rw=-1,s.setCheckAllBox(),s.pages.cursor=e.cursor,s.pages.total=e.total,s.pages.nodeLength=s.vnodeList.length})).finally((function(){s.selectedItemLabel="",s.loading=!1,0==s.vnodeList.length?s.emptyText="空数据":s.emptyText="请选择数据实例"}))}else this.vnodeList=[]},onClick:function(e){this.cur_name=e.label,this.$emit("table",e,this.type)},onAuthAsync:function(e,t){var s=this;console.log("owner.ae:",this.owner.ae," owner.aq:",this.owner.aq);var a="",i="",o=0;if(3!=this.owner.rw&&""!=this.owner.rw&&-1!=this.owner.rw){if("ae"==t){if(i="文件导出",0==this.owner.ae&&0==e.ae)return void this.onError("该数据表所在实例不支持导出操作！");1==e.ae?(e.ae=0,a="取消"):(e.ae=1,a="设置"),o=e.ae}if("aq"==t){if(i="异步查询",0==this.owner.aq&&0==e.aq)return void this.onError("该数据表所在实例不支持异步查询操作！");1==e.aq?(e.aq=0,a="取消"):(e.aq=1,a="设置"),o=e.aq}if("as"==t){if(i="导出Sql",0==this.owner.as&&0==e.as)return void this.onError("该数据表所在实例不支持导出Sql操作！");1==e.as?(e.as=0,a="取消"):(e.as=1,a="设置"),o=e.as}if("aw"==t){if(i="工单流程",0==this.owner.aw&&0==e.aw)return void this.onError("该数据表所在实例不支持工单流程操作！");1==e.aw?(e.aw=0,a="取消"):(e.aw=1,a="设置"),o=e.aw}this.addTablePermAsync(e,t,o).then((function(){var t=a+i+"成功";s.onSuccess(t),s.this.onSelectRow(e)}))}else this.onError("该数据表所在实例不支持该操作！")},onAuth:function(e,t,s){var a=this;return console.log("onAuth rw:",t),3==this.owner.rw||""==this.owner.rw||-1==this.owner.rw?this.onError("该数据表所在实例不支持该操作！"):1!=this.owner.rw||2!=t&&4!=t?2==this.owner.rw&&4==t?this.onError("该数据表所在实例不支持该操作！"):void this.addTablePerm(e.label,t).then((function(s){e.rw=t,e.rw&&-1!=e.rw?(e.ae=s.asyn_export,e.aq=s.asyn_query,e.as=s.asyn_sql):(e.ae=0,e.aq=0,e.as=0);var i="操作成功";3==t?i="设置禁用成功":4==t?i="设置管理成功":1==t?i="设置只读成功":2==t?i="设置读写成功":-1==t&&(i="取消设置成功"),a.onSuccess(i),a.onSelectRow(e)})):this.onError("该数据表所在实例不支持该操作！")},onBatchConfirm:function(e){var t=this,s=!0;if(3==this.owner.rw||""==this.owner.rw||-1==this.owner.rw?(console.warn("[table.list methods] 数据库被禁：",this.owner.rw,this.owner),s=!1):1!=this.owner.rw||2!=e.rw&&4!=e.rw?2==this.owner.rw&&4==e.rw?s=!1:-1==e.rw&&(e.rw=null,this.$message.warning("[warn-201] 没有选择读写权限")):s=!1,!s)return this.$message.error("[err-201] 权限选择错误"),this.loading=!1,void this.$refs.dialogBatchauthRef.hide();var a=this.selectedNodeList;this.loading=!0;var i=[];console.log("[table.list methods] onBatchaConfirm 设置后的权限:",e),a.forEach((function(s){i.push(t.addTablePerm2(s.label,e.rw,e.aq,e.ae,e.as))})),Promise.all(i).then((function(){for(var s="操作成功",i=0;i<a.length;i++)a[i].rw=e.rw,a[i].aq=e.aq,a[i].ae=e.ae,a[i].as=e.as;t.onSuccess(s)})).catch((function(){t.onError("操作失败"),t.refresh(null,!0)})).finally((function(){t.loading=!1,t.$refs.dialogBatchauthRef.hide()}))},addTablePerm2:function(e,t,s,a,i){var o={roleId:this.role.id,dbId:this.owner.db.id,towner:this.owner.label,tname:e,rw:t,aq:s,ae:a,as:i,type:this.type,project:this.project.id};return this.$api.permission.addPermission(o)},addTablePerm:function(e,t){return this.$api.permission.addTable(this.role.id,this.owner.db.id,this.owner.label,e,t,this.type,this.project.id)},addTablePermAsync:function(e,t,s){return this.$api.permission.addAsyncPermission(this.role.id,this.owner.db.id,this.owner.label,e.label,e.rw,t,s,this.project.id)},setCheckAllBox:function(){this.isCheckAll=this.selectedNodeList.length===this.vnodeList.length&&0!=this.selectedNodeList.length,this.isCheckAll?this.isIndeterminate=!1:this.selectedNodeList.length>0?this.isIndeterminate=!0:0==this.selectedNodeList.length&&(this.isCheckAll=!1,this.isIndeterminate=!1)},onSelectRow:function(e){this.selectedItemLabel=e.label,"redis"!=this.owner.db_type&&this.onClick(e),this.$emit("refresh-next","table")}},components:{"dialog-batchauth":Y,"virtual-list":se.a},mounted:function(){var e=this;this.$on("vnode-change",(function(t){var s=t.type,a=t.source,i=t.e,o=t.auth;"selected-line"==s?e.onSelectRow(a):"checked-item"==s?(i?(e.selectedNodeList.push(a),e.setCheckAllBox()):(e.selectedNodeList=e.selectedNodeList.filter((function(e){return a.label!=e.label})),e.setCheckAllBox()),console.log("checked-item: ",a,i?"选中":"取消")):"change-auth"==s?(console.log("change-auth: 读、写、管、禁",a,o),e.onAuth(a,o.value)):"change-auth2"==s&&e.onAuthAsync(a,o.key)}));var t=Object(he["a"])(this.$refs["table-vlist"],this.itemHeight);this.vlistKeeps=t||this.vlistKeeps}},fe=ue,pe=(s("b9c7b"),s("f040"),Object(p["a"])(fe,Z,ee,!1,null,"5015ef44",null)),me=pe.exports,be=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("k-card",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{head:"数据字段"}},[s("span",[s("el-input",{attrs:{size:"small",placeholder:"输入关键字进行过滤",clearable:""},model:{value:e.filterText,callback:function(t){e.filterText=t},expression:"filterText"}})],1),s("template",{slot:"tools"},[s("el-button",{attrs:{type:"primary",size:"mini"},on:{click:e.refresh}},[e._v("刷新 ")])],1),s("div",{staticClass:"role-column-list"},[e.dataList&&e.dataList.length>0?s("div",{staticClass:"item hbox-between no-user-select"},[s("div",{staticClass:"left"},[s("el-checkbox",{on:{change:function(t){return e.checkAllChangeHandler(t,!0)}},model:{value:e.isCheckAll,callback:function(t){e.isCheckAll=t},expression:"isCheckAll"}},[e._v("全选")])],1),s("div",{staticClass:"right"},[s("span",{staticClass:"pointer-active sn-font",attrs:{title:"批量读"},on:{click:function(t){return e.onAuth({id:"全部"},1)}}},[e._v("读")]),s("span",{staticClass:"pointer-active sn-font",attrs:{title:"批量写"},on:{click:function(t){(2==e.table.rw||4==e.table.rw)&&e.onAuth({id:"全部"},2)}}},[e._v("写")]),s("span",{staticClass:"pointer-active sn-font",attrs:{title:"批量管"},on:{click:function(t){t.stopPropagation(),e.owner.parent.hasMN&&4==e.owner.rw&&e.onAuth({id:"全部"},4)}}},[e._v("管")]),s("span",{staticClass:"pointer-active sn-font",attrs:{title:"批量敏"},on:{click:function(t){return e.onAuth({id:"全部"},3)}}},[e._v("敏")])])]):e._e(),s("el-tree",{ref:"colList",attrs:{data:e.dataList,"node-key":"label","show-checkbox":!0,"default-checked-keys":e.def_checks,props:e.treeProps,"highlight-current":"","empty-text":"redis"==e.owner.db_type?"[redis] 没有字段":"请选择数据表","filter-node-method":e.filterNode},on:{"check-change":e.handleCheckChange},scopedSlots:e._u([{key:"default",fn:function(t){var a=t.node,i=t.data;return s("div",{staticClass:"item hbox-between"},[s("div",{staticClass:"left flex-over"},[s("span",{staticClass:"pointer-default",class:{"auth-read":1==i.rw,"auth-write":2==i.rw,"auth-disable":3==i.rw,"auth-manage":4==i.rw},attrs:{title:i.label}},[e._v(e._s(i.label))])]),s("div",{staticClass:"right no-user-select"},[s("i",{staticClass:"sn-font pointer-active",class:{"auth-read":1==i.rw},attrs:{title:"读"},on:{click:function(t){return e.onAuth(i,1)}}},[e._v("读")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-write":2==i.rw},attrs:{title:"写"},on:{click:function(t){(2==e.table.rw||4==e.table.rw)&&e.onAuth(i,2)}}},[e._v("写")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-manage":4==i.rw},attrs:{title:"管"},on:{click:function(t){t.stopPropagation(),e.owner.parent.hasMN&&4==e.owner.rw&&e.onAuth(i,4)}}},[e._v("管")]),s("i",{staticClass:"sn-font pointer-active",class:{"auth-disable":3==i.rw},attrs:{title:"敏"},on:{click:function(t){return e.onAuth(i,3,a)}}},[e._v("敏")])])])}}])})],1),s("dialog-mask",{ref:"maskDialog",attrs:{role:e.role,owner:e.owner,table:e.table}})],2)},ve=[],we=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-dialog",{directives:[{name:"dialogDrag",rawName:"v-dialogDrag"}],attrs:{title:"脱敏规则",visible:e.isShow,modal:!1,width:"420px"},on:{"update:visible":function(t){e.isShow=t}}},[s("el-form",{ref:"form",attrs:{size:"small",model:e.formData,"label-suffix":":","label-width":"80px"}},[s("el-form-item",{attrs:{label:"字段名称"}},[e.ismut?s("div",{staticStyle:{"white-space":"pre-line"}},[e._v(" "+e._s(e.columns.join(","))+" ")]):s("span",[e._v(" "+e._s(e.column.label)+" ")])]),s("el-form-item",{attrs:{label:"替换规则"}},[s("el-radio-group",{model:{value:e.formData.type,callback:function(t){e.$set(e.formData,"type",t)},expression:"formData.type"}},[s("el-radio",{attrs:{label:1}},[e._v("隐藏")]),s("el-radio",{attrs:{label:2}},[e._v("打码")]),s("el-radio",{attrs:{label:3}},[e._v("替换")])],1)],1),1==e.formData.type?[s("el-form-item",{attrs:{label:"显示文字"}},[s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"隐藏后显示文字，可修改。",placement:"top"}},[s("el-input",{staticStyle:{width:"220px"},attrs:{maxlength:20},model:{value:e.formData.hide_str,callback:function(t){e.$set(e.formData,"hide_str",t)},expression:"formData.hide_str"}})],1)],1)]:e._e(),2==e.formData.type?[s("el-form-item",{attrs:{label:"打码方式"}},[s("el-radio-group",{model:{value:e.formData.opt_type,callback:function(t){e.$set(e.formData,"opt_type",t)},expression:"formData.opt_type"}},[s("el-radio",{attrs:{label:1}},[e._v("两边打码")]),s("el-radio",{attrs:{label:2}},[e._v("中间打码")])],1)],1),s("el-form-item",{attrs:{label:"替换字符"}},[s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"打码的替换字符,默认*",placement:"top"}},[s("el-input",{attrs:{maxlength:1},model:{value:e.formData.opt_str,callback:function(t){e.$set(e.formData,"opt_str",t)},expression:"formData.opt_str"}})],1)],1),1==e.formData.opt_type?s("el-form-item",{attrs:{label:"替换位置"}},[s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"前几位打码",placement:"top"}},[s("el-input",{staticStyle:{width:"120px"},attrs:{placeholder:"前几位打码"},model:{value:e.formData.front,callback:function(t){e.$set(e.formData,"front",t)},expression:"formData.front"}})],1),s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"后几位打码",placement:"top"}},[s("el-input",{staticStyle:{width:"120px"},attrs:{placeholder:"后几位打码"},model:{value:e.formData.end,callback:function(t){e.$set(e.formData,"end",t)},expression:"formData.end"}})],1),s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"不替换的字符",placement:"top"}},[s("el-input",{staticStyle:{width:"120px"},attrs:{placeholder:"不替换的字符",maxlength:1},model:{value:e.formData.ignore,callback:function(t){e.$set(e.formData,"ignore",t)},expression:"formData.ignore"}})],1)],1):e._e(),2==e.formData.opt_type?s("el-form-item",{attrs:{label:"替换位置"}},[s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"中间替换几位",placement:"top"}},[s("el-input",{staticStyle:{width:"120px"},attrs:{placeholder:"中间替换几位"},model:{value:e.formData.front,callback:function(t){e.$set(e.formData,"front",t)},expression:"formData.front"}})],1),s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"不替换的字符",placement:"top"}},[s("el-input",{staticStyle:{width:"120px"},attrs:{placeholder:"不替换的字符",maxlength:1},model:{value:e.formData.ignore,callback:function(t){e.$set(e.formData,"ignore",t)},expression:"formData.ignore"}})],1)],1):e._e()]:e._e(),3==e.formData.type?[s("el-form-item",{attrs:{label:"替换规则"}},[s("el-select",{model:{value:e.maskCode,callback:function(t){e.maskCode=t},expression:"maskCode"}},e._l(e.replaceRules,(function(e){return s("el-option",{key:e.k,attrs:{label:e.v,value:e.k}})})),1)],1),s("el-form-item",{attrs:{label:"是否唯一"}},[s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"设置后，生成的伪数据不会重复",placement:"top"}},[s("el-checkbox",{model:{value:e.formData.unique,callback:function(t){e.$set(e.formData,"unique",t)},expression:"formData.unique"}})],1)],1),s("el-form-item",{attrs:{label:"全局唯一"}},[s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"设置后，生成的伪数据不会重复,相同的源数据生成的伪数据相同。",placement:"top"}},[s("el-checkbox",{model:{value:e.formData.global,callback:function(t){e.$set(e.formData,"global",t)},expression:"formData.global"}})],1)],1),s("el-form-item",{attrs:{label:"关联KEY"}},[s("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"关联key,通常为主键或者外键。设置后，相同关联key的生成的伪数据相同。",placement:"top"}},[s("el-select",{model:{value:e.formData.global_key,callback:function(t){e.$set(e.formData,"global_key",t)},expression:"formData.global_key"}},e._l(e.columnList,(function(e){return s("el-option",{key:e.label,attrs:{value:e.label}})})),1)],1)],1)]:e._e()],2),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e.canbeDelete?s("el-button",{attrs:{type:"danger"},on:{click:e.onDelete}},[e._v("取消设置")]):e._e(),s("el-button",{attrs:{type:"success"},on:{click:e.onSubmit}},[e._v("设置脱敏")])],1)],1)},ge=[],ke={data:function(){return{ismut:!1,isShow:!1,formData:this.reset(),columnList:[],column:{},columns:[],canbeDelete:!1,maskCode:"101",replaceRules:[{k:"301",v:"身份证"},{k:"302",v:"手机"},{k:"303",v:"姓名"},{k:"304",v:"地址"},{k:"305",v:"银行卡"},{k:"307",v:"价格"},{k:"308",v:"邮箱"},{k:"309",v:"ip地址"}]}},props:{role:{},owner:{},table:{}},watch:{"formData.type":function(e){switch(e){case 1:this.maskCode="101";break;case 2:this.maskCode="201";break;case 3:this.maskCode="301";break}}},computed:{},methods:{reset:function(){return{project_id:null,type:1,maskCode:"101",hide_str:"(敏感信息,屏蔽显示)",opt_type:1,opt_str:"*",front:"1",end:"1",ignore:"",unique:!1,global:!1,global_key:""}},show:function(e,t,s,a,i){this.columnList=e,this.project_id=i,this.column=t,this.isShow=!0,this.maskCode="",a?(this.ismut=!0,this.columns=s.filter((function(e){return"全部"!=e})),this.formData=this.reset(),this.canbeDelete=!1):(this.ismut=!1,this.columns=[],t.maskConfig&&t.maskConfig.type?(this.formData=Object(c["a"])({},t.maskConfig),this.canbeDelete=!0,this.maskCode=t.maskCode):(this.formData=this.reset(),this.canbeDelete=!1))},hide:function(e){this.isShow=!1},onDelete:function(){var e=this;this.$api.permission.remove({role_id:this.role.id,db_id:this.owner.db.id,towner:this.owner.label,tname:this.table.label,tcol:this.column.label}).then((function(){e.column.maskConfig={},e.column.rw=e.column.parent.rw,e.onSuccess("取消成功"),e.hide()}))},addColMask:function(e){return this.$api.permission.addColumn(this.role.id,this.owner.db.id,this.owner.label,this.table.label,e,this.formData,3,this.maskCode,3,this.project_id)},onSubmit:function(){var e=this;if(this.ismut){for(var t=[],s=0;s<this.columns.length;s++)t.push(this.addColMask(this.columns[s]));Promise.all(t).then((function(t){console.log("== cols:",t);for(var s=0;s<e.columnList.length;s++)if(e.columns.includes(e.columnList[s].label)){for(var a=0;a<t.length;a++)if(t[a].tcol==e.columnList[s].label){e.columnList[s].id=t[a].id;break}e.columnList[s].maskConfig=Object(c["a"])({},e.formData),e.columnList[s].maskCode=e.maskCode,e.columnList[s].rw=3}e.onSuccess("设置成功"),e.hide()}))}else this.addColMask(this.column.label).then((function(t){console.log("col.id:",t.id," column.id:",e.column.id),e.column.id=t.id,e.column.maskConfig=Object(c["a"])({},e.formData),e.column.maskCode=e.maskCode,e.column.rw=3,e.onSuccess("设置成功"),e.hide()}))}},mounted:function(){},components:{}},_e=ke,ye=Object(p["a"])(_e,we,ge,!1,null,null,null),Ce=ye.exports,xe={data:function(){return{isCheckAll:!1,filterText:"",loading:!1,dataList:[],def_checks:[],ids:[],treeProps:{id:"id",label:"label",isLeaf:"leaf"}}},props:{role:{},owner:{},table:{},type:{type:String,default:""},project_id:{}},watch:{table:{handler:function(){console.log("[column.list watch] table 刷新"),this.refresh()}},filterText:function(e){this.$refs.colList.filter(e)}},methods:{checkAllChangeHandler:function(e,t){if(console.log("触发全选、反选",e,t),t)e?this.$refs.colList.setCheckedKeys(this.ids):this.$refs.colList.setCheckedKeys([]);else{var s=this.$refs.colList.getCheckedKeys(),a=this.ids.filter((function(e){return-1==s.indexOf(e)}));if(console.log("反选差集：",a),this.$refs.colList.setCheckedKeys(a),a.length==this.ids.length)return void(this.isCheckAll=!0);this.isCheckAll=!1}},handleCheckChange:function(e,t){console.log(e,t);var s=this.$refs.colList.getCheckedKeys();console.log("id:",e.id,s.length,this.ids.length),this.isCheckAll=s.length==this.ids.length},filterNode:function(e,t){return!e||(console.log("data.label:",t.label,"  value:",e),-1!==t.label.toLowerCase().indexOf(e.toLowerCase()))},refresh:function(){var e=this;console.log("owner::::::",this.owner),this.def_checks=[],this.role.id&&this.owner.id&&this.table.id?(this.loading=!0,this.$api.permission.allColumn(this.role.id,this.owner.db.id,this.owner.label,this.table.label,this.table,this.type,this.project_id).then((function(t){if(e.dataList=t,e.ids=[],e.isCheckAll=!1,e.dataList)for(var s=0;s<e.dataList.length;s++)e.dataList[s].id=e.dataList[s].label,e.ids.push(e.dataList[s].id)})).finally((function(){e.loading=!1,console.log("this.dataList: 数据字段",e.dataList)}))):this.dataList=[]},addColPerm:function(e,t,s){return this.$api.permission.addColumn(this.role.id,this.owner.db.id,this.owner.label,this.table.label,e,{},t,"","",s)},onAuth:function(e,t){var s=this;if((3!=this.owner.rw&&1!=this.table.rw||3==t)&&(1!=this.owner.rw&&1!=this.table.rw||2!=t&&4!=t)&&-1!=this.owner.rw&&(2!=this.owner.rw&&2!=this.table.rw||4!=t)){var a=this.$refs.colList.getCheckedKeys(),i=!1;if("全部"==e.id&&(i=!0),0==a.length&&i)this.$message({message:"请勾选数据字段",type:"warning"});else if(3!=t)if(a.length>1&&i){for(var o=[],n=0;n<a.length;n++)"全部"!=a[n]&&o.push(this.addColPerm(a[n],t,this.project_id));Promise.all(o).then((function(){var a="操作成功";3==t?a="设置禁用成功":1==t?a="设置只读成功":2==t?a="设置读写成功":-1==t&&(a="取消设置成功");for(var i=s.$refs.colList.getCheckedNodes(),o=0;o<i.length;o++)i[o].rw=t,console.log("node:",i[o]);e.rw=t,s.onSuccess(a)}))}else this.addColPerm(e.label,t,this.project_id).then((function(){e.rw=t;var a="操作成功";3==t?a="设置禁用成功":1==t?a="设置只读成功":2==t?a="设置读写成功":-1==t&&(a="取消设置成功"),s.onSuccess(a)}));else this.$refs.maskDialog.show(this.dataList,e,a,i,this.project_id)}}},components:{DialogMask:Ce},mounted:function(){this.def_checks=[]}},Le=xe,De=(s("77ca"),Object(p["a"])(Le,be,ve,!1,null,null,null)),Se=De.exports,$e={data:function(){return{is_admin:!1,isShow:!1,title:"项目权限设置",projectId:"",selectProject:{id:""},selectRole:{},selectDbLink:"*",selectOwner:{},selectTable:{},selectType:"table"}},methods:{showHandle:function(){},show:function(e,t){var s=this;console.log("[role.index methods] show: ",e),this.projectId=e.id,this.$api.project.info(e.id).then((function(a){s.selectProject=a,""==a.other_config?s.configForm=a.other_config_po:s.configForm=JSON.parse(a.other_config),s.title="项目【"+e.name+"】权限设置(ESC退出)",s.is_admin=t,s.isShow=!0}))},hide:function(){this.is_admin=!1,this.id="",this.selectProject={id:""},this.selectRole={},this.selectOwner={},this.selectDbLink="",this.selectTable={},this.isShow=!1},onProject:function(e){this.selectProject=e,console.log("[role.index methods] onProject: ",e),this.projectId=e.id,this.selectRole={},this.selectOwner={},this.selectDbLink="",this.selectTable={},console.log("this.$refs.roleList:",this.$refs.roleList),this.$refs.roleList.refresh(e.id)},onRole:function(e){console.log("onRole......",e),this.selectRole=e,this.selectOwner={},this.selectDbLink="",this.selectTable={},this.$refs.dbList.doRefresh(e)},onOwner:function(e){console.log("onOwner: ",this.selectTable);var t=Object.keys(this.selectTable);t.length>0&&this.selectOwner!=e&&(this.selectTable={}),this.selectOwner=e},onRefreshNext:function(e){console.log("刷新。。。。",e),"owner"==e?(this.$refs.tabList.refresh(null,!0),this.selectTable={}):"table"==e&&this.$refs.colList.refresh()},onTable:function(e,t){this.selectTable=e,this.selectType=t}},components:{RoleList:z,InstanceList:X,ColumnList:Se,TableList:me}},je=$e,qe=(s("dc82"),Object(p["a"])(je,a,i,!1,null,"09f6c4ac",null));t["default"]=qe.exports},e635:function(e,t,s){"use strict";var a=s("5716"),i=s.n(a);i.a},f040:function(e,t,s){"use strict";var a=s("bff1"),i=s.n(a);i.a}}]);