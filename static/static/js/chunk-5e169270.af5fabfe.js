(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-5e169270"],{"148e":function(t,e,a){"use strict";var o=a("6ff8"),i=a.n(o);i.a},"1f82":function(t,e,a){"use strict";e["a"]={name:"ElCol",props:{span:{type:Number,default:24},tag:{type:String,default:"div"},offset:Number,pull:Number,push:Number,xs:[Number,Object],sm:[Number,Object],md:[Number,Object],lg:[Number,Object],xl:[Number,Object]},computed:{gutter(){let t=this.$parent;while(t&&"ElRow"!==t.$options.componentName)t=t.$parent;return t?t.gutter:0}},render(t){let e=[],a={};return this.gutter&&(a.paddingLeft=this.gutter/2+"px",a.paddingRight=a.paddingLeft),["span","offset","pull","push"].forEach(t=>{(this[t]||0===this[t])&&e.push("span"!==t?`el-col-${t}-${this[t]}`:"el-col-"+this[t])}),["xs","sm","md","lg","xl"].forEach(t=>{if("number"===typeof this[t])e.push(`el-col-${t}-${this[t]}`);else if("object"===typeof this[t]){let a=this[t];Object.keys(a).forEach(o=>{e.push("span"!==o?`el-col-${t}-${o}-${a[o]}`:`el-col-${t}-${a[o]}`)})}}),t(this.tag,{class:["el-col",e],style:a},this.$slots.default)}}},"2e0b":function(t,e,a){"use strict";e["a"]={name:"ElRow",componentName:"ElRow",props:{tag:{type:String,default:"div"},gutter:Number,type:String,justify:{type:String,default:"start"},align:{type:String,default:"top"}},computed:{style(){const t={};return this.gutter&&(t.marginLeft=`-${this.gutter/2}px`,t.marginRight=t.marginLeft),t}},render(t){return t(this.tag,{class:["el-row","start"!==this.justify?"is-justify-"+this.justify:"","top"!==this.align?"is-align-"+this.align:"",{"el-row--flex":"flex"===this.type}],style:this.style},this.$slots.default)}}},"3e41":function(t,e,a){},"675e":function(t,e,a){},"6ff8":function(t,e,a){},"7f70":function(t,e,a){"use strict";var o=a("3e41"),i=a.n(o);i.a},"8dfd":function(t,e,a){"use strict";var o=a("aeec"),i=a.n(o);i.a},"8f1ce":function(t,e,a){"use strict";var o=a("b82d"),i=a.n(o);i.a},"9d5f":function(t,e,a){"use strict";var o=a("675e"),i=a.n(o);i.a},aeec:function(t,e,a){},b82d:function(t,e,a){},c58e:function(t,e,a){"use strict";var o=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-dialog",{staticClass:"work-detail-dialog",attrs:{visible:t.isShow,fullscreen:"",width:"100%","before-close":t.hide,"append-to-body":""},on:{"update:visible":function(e){t.isShow=e}}},[a("div",{staticClass:"work-detail-dialog-title",attrs:{slot:"title"},slot:"title"},[a("span",[t._v(" 工单详情 ")]),a("el-button",{attrs:{loading:t.workInfoLoading,size:"mini",type:"primary",round:"",icon:"el-icon-refresh"},nativeOn:{click:function(e){return t.onRefresh(e)}}},[t._v("刷新")])],1),a("div",[a("div",{staticClass:"box-card margin-b-10"},[a("el-table",{staticClass:"el-card is-always-shadow",staticStyle:{width:"100%"},attrs:{data:t.workData,"highlight-current-row":!0,border:!0,"row-class-name":"success-row"}},[a("el-table-column",{attrs:{prop:"name",label:"工单名称"}}),a("el-table-column",{attrs:{prop:"create_name",label:"发起人"}}),a("el-table-column",{attrs:{label:"工单状态",width:"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",{staticStyle:{"font-weight":"bold",color:"red"}},[t._v(" "+t._s(t.showStatus(e.row.status))+" ")])]}}])}),a("el-table-column",{attrs:{prop:"project_name",label:"项目"}}),a("el-table-column",{attrs:{prop:"db_name",label:"数据源/数据库"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.db_name)+"/"+t._s(e.row.owner)+" ")]}}])}),a("el-table-column",{attrs:{width:"120",prop:"project_name",label:"类型"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t.showWorkType(e.row.type))+" ")]}}])}),a("el-table-column",{attrs:{prop:"sql_audit_auth_str",label:"审批流程"}}),a("el-table-column",{attrs:{prop:"cur_audit_str",label:"当前审批组"}}),a("el-table-column",{attrs:{prop:"db_name",label:"发起时间",width:"160"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t._f("dateTime")(e.row.created_at))+" ")]}}])})],1)],1),a("el-tabs",{attrs:{type:"border-card"},on:{"tab-click":t.tabHandleClick},model:{value:t.tabActiveName,callback:function(e){t.tabActiveName=e},expression:"tabActiveName"}},[a("el-tab-pane",{staticClass:"tabs-detail",attrs:{name:"detail",label:"工单详情"}},[t.formData.id?a("div",[a("el-form",{ref:"form",attrs:{"label-position":"left",model:t.formData,"label-suffix":":",rules:t.formRule}},[a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"工单编号"}},[t._v(" "+t._s(t.formData.id)+" ")])],1),a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"发起人"}},[t._v(" "+t._s(t.formData.create_name)+" ")])],1)],1),a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"工单状态"}},[a("span",{staticStyle:{"font-weight":"bold",color:"red"}},[t._v(t._s(t.showStatus(t.formData.status)))])])],1),a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"项目"}},[t._v(" "+t._s(t.formData.project_name)+" ")])],1)],1),a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"数据源/数据库"}},[t._v(" "+t._s(t.formData.db_name)+"/"+t._s(t.formData.owner)+" ")])],1),a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"类型"}},[t._v(" "+t._s(t.showWorkType(t.formData.type))+" ")])],1)],1),a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"目标数据库类型"}},[t._v(" "+t._s(t.formData.db_type)+" ")])],1),a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"是否备份"}},[1==t.formData.back_up?a("span",[t._v("是")]):a("span",[t._v("否")])])],1)],1),a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:24}},[a("el-form-item",{attrs:{label:"可执行时间范围"}},[a("el-tag",{attrs:{type:"danger"}},[t._v(t._s(t.showExecTime(t.formData)))])],1)],1)],1),a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"审批流程"}},[t._v(" "+t._s(t.formData.sql_audit_auth_str)+" ")])],1),a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"当前审批组"}},[t._v(" "+t._s(t.formData.cur_audit_str)+" ")])],1)],1),a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"发起时间"}},[t._v(" "+t._s(t._f("dateTime")(t.formData.created_at))+" ")])],1),a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"最后更新时间"}},[t._v(" "+t._s(t._f("dateTime")(t.formData.updated_at))+" ")])],1)],1),a("el-row",{attrs:{gutter:20}},[a("el-col",[a("el-form-item",{attrs:{label:"工单描述"}},[t.formData.mark?a("el-input",{staticClass:"work-description",attrs:{type:"textarea",rows:4,readonly:!0,placeholder:"请输入内容"},model:{value:t.formData.mark,callback:function(e){t.$set(t.formData,"mark",e)},expression:"formData.mark"}}):a("span",[t._v("无")])],1)],1)],1)],1)],1):t._e()]),a("el-tab-pane",{attrs:{name:"sql",label:"执行脚本",lazy:!0}},[t.sqlVisiable?a("div",{attrs:{slot:"label"},slot:"label"},[a("i",{staticClass:"sn-font"},[t._v("")]),t._v(" 执行脚本 ")]):a("el-badge",{staticClass:"item",attrs:{slot:"label",value:"查看"},slot:"label"},[a("i",{staticClass:"sn-font"},[t._v("")]),t._v(" 执行脚本 ")]),t.showSql?a("work-sql",{ref:"workSql",attrs:{formData:t.formData}}):t._e()],1),a("el-tab-pane",{directives:[{name:"loading",rawName:"v-loading",value:t.sqlAuditLoading,expression:"sqlAuditLoading"}],attrs:{name:"audit",label:"审计/执行日志"}},[a("sql-audit-log",{ref:"sqlAuditLog",attrs:{logData:t.sqlAuditData}}),a("el-pagination",{attrs:{"current-page":t.auditLogPages.pageNo,"page-sizes":[10,20,30,50],"page-size":t.auditLogPages.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:t.auditLogPages.total},on:{"size-change":t.handleSizeChange,"current-change":t.handleCurrentChange}})],1),a("el-tab-pane",{attrs:{name:"aciton",label:"审批/操作日志"}},[a("audit-log",{ref:"auditLog",attrs:{logData:t.logData}})],1)],1),a("el-card",{staticClass:"box-card action margin-top-10"},[a("el-form",{ref:"form2",attrs:{model:t.formData,"label-width":"80px"}},[0==t.formData.status||1==t.formData.status?a("el-form-item",{attrs:{label:"备注"}},[a("el-input",{attrs:{type:"textarea",placeholder:"填写审核备注/终止原因"},model:{value:t.formData.cancel_remark,callback:function(e){t.$set(t.formData,"cancel_remark",e)},expression:"formData.cancel_remark"}})],1):t._e(),a("el-form-item",[t.is_admin&&0==t.formData.status?a("el-button",{attrs:{type:"primary",plain:""},on:{click:t.onChangeExecTime}},[t._v(" 执行时间变更 ")]):t._e(),t.is_admin&&0==t.formData.status?a("el-button",{attrs:{type:"success",plain:""},on:{click:t.onOk}},[t._v(" 审核通过 ")]):t._e(),1==t.formData.status?a("el-button",{attrs:{type:"danger",plain:""},on:{click:function(e){return t.onExec(5)}}},[t._v("立即执行")]):t._e(),1==t.formData.status&&1==t.formData.work_manual?a("k-btn-tip",{attrs:{tip:"确定已经手工执行成功？"},on:{click:function(e){return t.onExec(8)}}},[a("el-button",{staticStyle:{width:"100%"},attrs:{size:"medium",type:"primary"}},[t._v("手动执行")])],1):t._e(),0==t.formData.status||1==t.formData.status?a("el-button",{attrs:{type:"warning",plain:""},on:{click:t.onCancel}},[t._v(" 终止流程 ")]):t._e()],1)],1)],1),a("dialog-edit-exec-time",{ref:"editExecTimeDialog",on:{refresh:t.init}}),a("dialog-exec-scheduler",{ref:"execSchedulerDialog",on:{refresh:t.init}})],1)])},i=[],s=(a("d3b7"),a("ac1f"),a("5530")),r=a("2f62"),l=a("5c96"),n=a("2ef0"),c=a("6ace"),u=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticStyle:{"padding-bottom":"50px"}},[a("el-table",{staticStyle:{width:"100%"},attrs:{data:t.logData,border:!0}},[a("el-table-column",{attrs:{prop:"opt_desc",label:"操作",width:"180"}}),a("el-table-column",{attrs:{prop:"create_name",label:"操作人",width:"300"}}),a("el-table-column",{attrs:{prop:"opt_ip",label:"操作IP",width:"330"}}),a("el-table-column",{attrs:{prop:"db_name",label:"操作时间",width:"160"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t._f("dateTime")(e.row.created_at))+" ")]}}])}),a("el-table-column",{attrs:{prop:"opt_info",label:"操作信息"}})],1)],1)},d=[],f={data:function(){return{}},props:{logData:Array},watch:{},computed:{},methods:{},mounted:function(){},components:{}},h=f,m=a("2877"),p=Object(m["a"])(h,u,d,!1,null,null,null),b=p.exports,g=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticStyle:{"padding-bottom":"50px"}},[a("el-table",{staticStyle:{width:"100%"},attrs:{data:t.logData,border:!0}},[a("el-table-column",{attrs:{type:"expand"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("pre",{staticClass:"sql bg-color"},[t._v(t._s(e.row.sql))])]}}])}),a("el-table-column",{attrs:{prop:"id",label:"ID",width:"50"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.sql_no)+" ")]}}])}),a("el-table-column",{attrs:{"show-overflow-tooltip":!0,prop:"sql",label:"SQL语句"}}),a("el-table-column",{attrs:{prop:"level",width:"80",label:"审核/执行状态"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("el-tag",{attrs:{type:t.showLevelTagType(e.row.level)}},[t._v(" "+t._s(t.showLevel(e.row.level))+" ")])]}}])}),a("el-table-column",{attrs:{prop:"result",width:"200",label:"审核/执行信息"}}),a("el-table-column",{attrs:{prop:"affected_rows",label:"扫描/影响行数",width:"80"}}),a("el-table-column",{attrs:{prop:"execute_time",width:"100",label:"执行耗时"}}),a("el-table-column",{attrs:{prop:"stage_status",width:"200",label:"当前阶段"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t.showStageStatus(e.row.stage_status))+" ")]}}])})],1)],1)},w=[],_={data:function(){return{}},props:{logData:Array},watch:{},computed:{},methods:{showStageStatus:function(t){return this.$api.work.showStageStatus(t)},showStage:function(t){return this.$api.work.showStage(t)},showLevel:function(t){return this.$api.work.showLevelStyle(t)},showLevelTagType:function(t){return this.$api.work.showLevelTagType(t)}},mounted:function(){},components:{}},v=_,k=Object(m["a"])(v,g,w,!1,null,null,null),D=k.exports,S=function(){var t=this,e=t.$createElement;t._self._c;return t._m(0)},y=[function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"editor-container"},[a("pre",{staticClass:"editor work-sql-monaco-x1",staticStyle:{"min-height":"200px"}}),a("span",{staticStyle:{float:"right","fonst-size":".8rem",color:"red"}},[t._v("这里可拖动大小↑")])])}],x={data:function(){return{editor:null}},props:{formData:{}},watch:{formData:function(t){t&&(console.log("==============22222========================="),this.init(t.sql))}},computed:{},methods:{refresh:function(t){this.init(t)},init:function(t){if(this.editor)this.editor.setValue(t);else{var e=this.$el.getElementsByClassName("work-sql-monaco-x1")[0];this.editor=monaco.editor.create(e,{value:t,language:"sql",theme:"vs",automaticLayout:!0,selectionHighlight:!0,wordWrap:"on",readOnly:!0,scrollbar:{useShadows:!1,verticalHasArrows:!0,horizontalHasArrows:!0,vertical:"hidden",horizontal:"hidden",verticalScrollbarSize:0,horizontalScrollbarSize:17,arrowSize:30}})}}},mounted:function(){console.log("mounted:"),this.init(this.formData.sql)},components:{}},$=x,L=(a("9d5f"),Object(m["a"])($,S,y,!1,null,"60864c32",null)),q=L.exports,T=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("el-dialog",{attrs:{"custom-class":"database-edit",title:"定时执行SQL",visible:t.isShow,"append-to-body":""},on:{"update:visible":function(e){t.isShow=e}}},[a("el-form",{attrs:{model:t.formData,"label-width":"120px"}},[a("el-form-item",{attrs:{label:"执行时间"}},[a("el-date-picker",{model:{value:t.execTime,callback:function(e){t.execTime=e},expression:"execTime"}})],1)],1),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:t.hide}},[t._v("取 消")]),a("el-button",{attrs:{type:"primary"},on:{click:t.onSubmit}},[t._v("确定提交")])],1)],1)],1)},E=[],A=(a("2e0b"),a("1f82"),a("c1df")),C=a.n(A),j={data:function(){return{esConfigList:[],isShow:!1,execTime:"",formData:this.reset()}},computed:{},props:{},watch:{},methods:{reset:function(){return{exec_flag:1}},show:function(t){this.isShow=!0,this.formData=t},hide:function(){this.isShow=!1},onSubmit:function(){var t=this,e=n["cloneDeep"](this.formData);this.execTimes.length<2?this.onError("执行时间范围不能为空"):(console.log(this.execTimes),e.exec_start=C()(this.execTimes[0]).format("YYYY-MM-DD HH:mm:ss"),e.exec_end=C()(this.execTimes[1]).format("YYYY-MM-DD HH:mm:ss"),this.$api.work.changeTime(e).then((function(e){t.onSuccess("提交成功"),t.hide(),t.$emit("refresh")}),(function(e){var a="参数错误！";"301"!=e.result&&(a=e.data),t.onError(a)})))}},components:{},mounted:function(){}},N=j,O=(a("7f70"),Object(m["a"])(N,T,E,!1,null,"0f117691",null)),z=O.exports,Y=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("el-dialog",{attrs:{"custom-class":"database-edit",title:"修改可执行时间",visible:t.isShow,"append-to-body":""},on:{"update:visible":function(e){t.isShow=e}}},[a("el-form",{attrs:{model:t.formData,"label-width":"120px"}},[a("el-form-item",{attrs:{label:"时间范围"}},[a("el-date-picker",{attrs:{type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期"},model:{value:t.execTimes,callback:function(e){t.execTimes=e},expression:"execTimes"}})],1)],1),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:t.hide}},[t._v("取 消")]),a("el-button",{attrs:{type:"primary"},on:{click:t.onSubmit}},[t._v("确 定")])],1)],1)],1)},R=[],H={data:function(){return{esConfigList:[],isShow:!1,execTimes:[],formData:this.reset()}},computed:{},props:{},watch:{},methods:{reset:function(){return{exec_flag:1}},show:function(t){this.isShow=!0,this.formData=t},hide:function(){this.isShow=!1},onSubmit:function(){var t=this,e=n["cloneDeep"](this.formData);this.execTimes.length<2?this.onError("执行时间范围不能为空"):(console.log(this.execTimes),e.exec_start=C()(this.execTimes[0]).format("YYYY-MM-DD HH:mm:ss"),e.exec_end=C()(this.execTimes[1]).format("YYYY-MM-DD HH:mm:ss"),this.$api.work.changeTime(e).then((function(e){t.onSuccess("提交成功"),t.hide(),t.$emit("refresh")}),(function(e){var a="参数错误！";"301"!=e.result&&(a=e.data),t.onError(a)})))}},components:{},mounted:function(){}},P=H,M=(a("8dfd"),Object(m["a"])(P,Y,R,!1,null,"21ff9d8b",null)),I=M.exports,W={components:{AuditLog:b,WorkSql:q,SqlAuditLog:D,DialogEditExecTime:I,DialogExecScheduler:z},computed:Object(s["a"])({},Object(r["b"])(["showWorkType"])),data:function(){return{workInfoLoading:!1,tabActiveName:"detail",sqlVisiable:!1,sqlAuditLoading:!1,auditLogPages:{pageNo:1,pageSize:10,total:0},id:"",showSql:!1,is_admin:!1,isShow:!1,workData:[],sqlAuditData:[],logData:[],logData2:[],disabled:!0,config:{lang:"sql"},formData:{cancel_remark:"",id:"",source_type:"none",source_id:"none",sql:"",has_auth:!1,can_review:!1},formRule:{mark:[{required:!1,message:"请输入描述"}],audit_id:[{required:!0,message:"请选择审批人"}]},roleList:[]}},methods:{onRefresh:function(){this.show(this.id,!0)},tabHandleClick:function(){"sql"==this.tabActiveName?this.sqlVisiable=!0:"audit"==this.tabActiveName&&"执行中"==this.showStatus(this.formData.status)||"action"==this.tabActiveName&&this.showStatus(this.formData.status)},handleSizeChange:function(t){this.auditLogPages.pageSize=t,this.sqlAuditList(),console.log("每页 ".concat(t," 条"))},handleCurrentChange:function(t){this.auditLogPages.pageNo=t,this.sqlAuditList(),console.log("当前页: ".concat(t))},goWorkBackUp:function(){this.$refs.backupDialog.show(this.id)},show:function(t,e){var a=this;this.id=t,this.$nextTick((function(){a.init(),a.isShow=!0,a.is_admin=e}))},showType:function(t){return 1==t?"DML":2==t?"DDL":"未知类型"},showStatus:function(t){return this.$api.work.showStatus(t)},onExec:function(t){var e=this,a=l["Loading"].service({fullscreen:!0,background:"transparent"});this.$api.work.exec(this.formData.id,t).then((function(t){a.close(),e.onSuccess("执行成功"),e.init(!0)}),(function(t){a.close();var o="参数错误！";"301"!=t.result&&(o=t.data),e.onError(o),e.init(!0)}))},onOk:function(){this.onSubmit("ok")},onFail:function(){this.onSubmit("fail")},onExecScheduler:function(){this.$refs.execSchedulerDialog.show(this.formData)},onChangeExecTime:function(){this.$refs.editExecTimeDialog.show(this.formData)},showExecTime:function(t){return 1==t.exec_flag?"不限":2==t.exec_flag?c["a"].formatTime(t.exec_start)+" 至 "+c["a"].formatTime(t.exec_end):"未知"},init:function(t){var e=this;this.id&&(this.workInfoLoading=!0,this.$api.work.info(this.id).then((function(t){e.formData=t,e.workData=[t],e.showSql=!0,e.refreshLog()})).finally((function(){e.workInfoLoading=!1})),t&&this.$emit("refresh"))},hide:function(){this.tabActiveName="detail",this.sqlVisiable=!1,this.isShow=!1,this.is_admin=!1,this.id="",this.formData={sql:""},this.showSql=!1,this.workData=[]},refreshLog:function(){var t=this;this.$api.work.logList(this.formData.id,-1,-1).then((function(e){t.logData=e.list,t.logData&&t.logData.length>0?t.logData2=[t.logData[0]]:t.logData2=[{opt_info:"无"}],console.dir(t.logData2)})),this.sqlAuditList()},sqlAuditList:function(){var t=this;this.sqlAuditLoading=!0,this.$api.work.sqlAuditList(this.formData.id,this.auditLogPages.pageNo-1,this.auditLogPages.pageSize).then((function(e){t.auditLogPages=Object(s["a"])(Object(s["a"])({},t.auditLogPages),{},{total:e.count}),t.sqlAuditData=e.list})).finally((function(){setTimeout((function(){t.sqlAuditLoading=!1}),200)}))},onCancel:function(){var t=this,e=this.formData;if(e.cancel_remark){var a=1;this.is_admin&&(a=2),this.$api.work.cancel({id:e.id,cancel_remark:e.cancel_remark,flag:a}).then((function(){t.onSuccess("取消成功"),t.init(!0)}),(function(e){var a="参数错误！";"301"!=e.result&&(a=e.data),t.onError(a)}))}else this.onError("请输入终止原因")},onSubmit:function(t){var e=this,a=arguments,o=l["Loading"].service({fullscreen:!0,background:"transparent"}),i=n["clone"](this.formData);if("ok"==t)i.status=1;else if("fail"==t)i.status=2;else{if("cancel"!=t)return void this.onError("非法的审核结果");i.status=3}this.$api.work.audit(i).then((function(){e.onSuccess("操作成功"),e.init(!0),o.close()})).catch((function(t){console.error("[dialog.detail.vue]#onSubmit",a,t)})).finally((function(){o.close()}))}},mounted:function(){}},V=W,Q=(a("8f1ce"),a("148e"),Object(m["a"])(V,o,i,!1,null,null,null));e["a"]=Q.exports},d170:function(t,e,a){"use strict";var o=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-dialog",{attrs:{title:t.title,visible:t.isShow,fullscreen:"",width:"100%","before-close":t.hide,"append-to-body":""},on:{"update:visible":function(e){t.isShow=e}}},[a("div",{staticStyle:{"padding-bottom":"50px"}},[a("el-table",{staticStyle:{width:"100%"},attrs:{data:t.backupData,border:!0,height:"400",border:""}},[a("el-table-column",{attrs:{type:"expand"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",[t._v(t._s(e.row.back_up_sql))])]}}])}),a("el-table-column",{attrs:{label:"执行语句",prop:"sql"}}),a("el-table-column",{attrs:{prop:"back_up_sql",label:"回滚语句"}})],1),a("el-form",[a("el-form-item",[a("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitRollback()}}},[t._v("提交回滚")]),a("el-button",{on:{click:function(e){return t.downloadRollback("ruleForm")}}},[t._v("下载回滚SQL")])],1)],1)],1)])},i=[],s=(a("b0c0"),{data:function(){return{id:"",work:{name:"",sql:""},title:"",is_admin:!1,isShow:!1,backupData:[]}},props:{logData:Array},watch:{},computed:{},methods:{submitRollback:function(){for(var t=this,e="",a=0;a<this.backupData.length;a++)e=e+this.backupData[a].back_up_sql+"\n";var o=this.work.project;o&&this.$api.my.myProjectList().then((function(e){if(e&&e.length>0)for(var a=0;a<e.length;a++)if(e[a].id==o){t.$store.commit("project",e[a]);break}})),this.$store.commit("addRun",{id:this.work.db_id,db:this.work.db_name,name:this.work.owner,auto_audit:!0,dbType:this.work.db_type,script:e,rw:2,owner:this.work.owner,hasAsynExport:!1,hasAsynQuery:!1,hasAsynSql:!1,hasRw:!0}),this.hide(),this.$router.push({path:"/query",params:{sql:e}})},downloadRollback:function(){var t=window.localStorage.getItem("token");this.$api.download("/api/work/backup/download",{id:this.id,access_token:t})},show:function(t,e){this.id=t,this.init(),this.isShow=!0,this.is_admin=e},showStatus:function(t){return this.$api.work.showStatus(t)},onChangeExecTime:function(){this.$refs.editExecTimeDialog.show(this.formData)},showExecTime:function(t){return 1==t.exec_flag?"不限":(t.exec_flag=2)?Util.formatTime(t.exec_start)+" 至 "+Util.formatTime(t.exec_end):"未知"},init:function(t){var e=this;this.id?this.$api.work.info(this.id).then((function(t){e.work=t,console.log("this.work:",JSON.stringify(e.work)),e.title="工单【"+t.name+"】备份信息",e.$api.work.backupList(e.id).then((function(t){e.backupData=t}))})):this.onError("出错了，没有获取到工单编号")},hide:function(){this.isShow=!1,this.is_admin=!1,this.id="",this.backupData=[],this.work={name:""},this.is_admin||this.$emit("hide")}},mounted:function(){},components:{}}),r=s,l=a("2877"),n=Object(l["a"])(r,o,i,!1,null,null,null);e["a"]=n.exports}}]);